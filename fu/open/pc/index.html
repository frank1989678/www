<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>陪玩</title>
    <meta name="renderer" content="webkit" />
    <link rel="stylesheet" href="css/style.css" />
</head>
<body>

<div class="form">
    <form name="myform" id="myform">
        <ul>
            <li>
                <label class="for">兑&nbsp;&nbsp;换&nbsp;&nbsp;码</label>
                <input type="text" name="code" class="ipt" autocomplete="off" placeholder="请输入您购买后获得的兑换码" data-msg="请输入兑换码">
                <span class="err"></span>
                <p class="tips">小提示：输入兑换码后自动选择服务类型</p>
            </li>
            <li>
                <label class="for">服务类型</label>
                <input type="text" name="type" class="ipt" readonly onfocus="this.blur()">
                <span class="err"></span>
            </li>
            <li class="region">
                <label class="for">跨&#12288;&#12288;区</label>
                <div class="slt">
                    <input type="text" name="gameArea" class="ipt" readonly onfocus="this.blur()" data-msg="请选择跨区">
                    <span class="err"></span>
                    <div class="select">
                        <div class="option" data-val="1">跨1</div>
                        <div class="option" data-val="2">跨2</div>
                        <div class="option" data-val="3">跨3</div>
                        <div class="option" data-val="4">跨4</div>
                        <div class="option" data-val="5">跨5</div>
                        <div class="option" data-val="6">跨6</div>
                        <div class="option" data-val="7">跨7</div>
                        <div class="option" data-val="8">跨8</div>
                    </div>
                </div>
            </li>
            <li>
                <label class="for">角&nbsp;&nbsp;色&nbsp;&nbsp;名</label>
                <input type="text" name="rolename" class="ipt" autocomplete="off" placeholder="" data-msg="请输入角色名">
                <span class="err"></span>
            </li>
            <li>
                <label class="for">手机号码</label>
                <input type="text" name="mobile" class="ipt" autocomplete="off" placeholder="" data-msg="请输入手机号码">
                <span class="err"></span>
            </li>
            <li class="button">
                <button type="submit" class="btn btn-submit">提交</button>
                <a href="query.html" class="btn btn-query1">查询兑换码</a>
            </li>
        </ul>
    </form>
</div>

<div class="foot">
    <dl>
        <dt><img width="90" height="90" src="images/qrcode.png" alt="二维码"></dt>
        <dd class="txt">客户服务请扫描二维码获取或联系 QQ：80240825</dd>
    </dl>
</div>

<!-- 公用 -->
<script src="js/jquery191.js"></script>
<script>
!(function($) {
    var sessionKey = '';
    var series = '';
    var lastKey = '';
    var baseURL = 'https://t-api-play.wzpeilian.com';

    $('.ipt').on('focus', function() {
        $(this).next('.err').hide().empty();
    })

    $('body').on('click', function() {
        $('.slt-open').removeClass('slt-open');
    })
    $('.slt').on('click', function() {
        $(this).addClass('slt-open');
        return false;
    })
    $('.slt').on('click', '.option', function() {
        var val = $(this).data('val');
        $('.ipt[name="gameArea"]').val($(this).html()).next('.err').hide();
        $('.slt-open').removeClass('slt-open');
        return false;
    })

    $('.ipt[name="code"]').on('blur', function() {
        var val = $.trim(this.value);
        var $this = $(this);
        if (val && lastKey != val) {
            // lastKey = val;
            $.ajax({
                url: baseURL + '/open/v1/cdk/type',
                type: 'POST',
                dataType: 'json',
                data: {series: val},
                success: function(res) {
                    console.log(res)
                    sessionKey = '';
                    series = '';
                    if (res.status === 500) {
                        $('.region').hide().find('.ipt').val('');
                        $('.ipt[name="type"]').val('');
                        $this.next('.err').html(res.msg).show();
                    } else if (res.status === 200) {
                        sessionKey = res.data.sessionKey;
                        series = val;
                        $('.ipt[name="type"]').val(res.data.type);
                        $this.next('.err').hide();
                        var stype = res.data.type;
                        if (stype.indexOf('阿古斯') === -1) {
                            $('.region').show();
                        } else {                            
                            $('.region').hide().find('.ipt').val('');
                        }
                    }
                }
            })
        }
    })

    $('#myform').on('submit', function() {
        var pass = true;

        var para = {
            sessionKey: sessionKey,
            series: series
        }

        $('.ipt').each(function() {
            var val = $.trim(this.value);
            if (this.name === 'type') {
                // 服务类型
            } else if (this.name === 'gameArea' && $('.region').is(':hidden')) {
                // wow没有跨区
            } else if (val.length === 0) {
                pass = false;
                $(this).next('.err').html($(this).data('msg')).show();
            } else if (this.name === 'mobile' && !/^1[3-9]\d{9}$/.test(val)) {
                pass = false;
                $(this).next('.err').html('手机号输入错误').show();
            } else {
                $(this).next('.err').hide().empty();
                para[this.name] = val;
            }
            return pass;
        })
        if (pass) {
            console.log(para)
            $.ajax({
                url: baseURL + '/open/v1/cdk/order',
                type: 'POST',
                dataType: 'json',
                data: para,
                success: function(res) {
                    if (res.status === 200) {
                        location.href = 'query.html?series=' + series;
                    }
                }
            })
        }
        return false;
    })
})(jQuery)

</script>
</body>
</html>