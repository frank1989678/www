<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>交通事故信息管理平台</title>
    <meta name="renderer" content="webkit" />
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="stylesheet" href="assets/plugins/datetimepicker/style.css" />
    <link rel="stylesheet" href="assets/plugins/select2/select2.css" />
    <link rel="stylesheet" href="assets/plugins/zTreeStyle/jquery.ztree.css" />
</head>
<body>

<!-- header begin -->
<div class="header">
	<div class="inner">
		<div class="user">
			<dl>
				<dt>系统管理员<i class="ico ico-arrow-down"></i></dt>
				<dd>
					<a href="changePwd.html">修改密码</a>
					<a href="login.html">安全退出</a>
				</dd>
			</dl>
		</div>
		<div class="logo">
			<a href="index.html">武汉市交通事故信息管理平台</a>
		</div>
		<div class="nav">
			<dl>
				<dt><i class="ico ico-1"></i><span>用户信息</span></dt>
				<dd>
					<div class="scroll">
						<a href="userList.html" class="current">用户信息</a>
						<a href="insuranceMessage.html">保险公司信息</a>
					</div>
				</dd>
			</dl>
			<dl>
				<dt><i class="ico ico-2"></i><span>警保联动</span></dt>
				<dd>
					<div class="scroll">
						<a href="caseList.html">警保案件信息</a>
						<a href="showCaseSummaryList.html">案件处理登记</a>
					</div>
				</dd>
			</dl>

			<dl>
				<dt><i class="ico ico-3"></i><span>警保统计</span></dt>
				<dd>
					<div class="scroll">
						<a href="caseInfoStatistics.html">案件信息统计</a>
						<a href="companyStatistics.html">查勘量统计(公司)</a>
						<a href="surveyMemberStatistics.html">查勘量统计(查勘员)</a>
						<a href="surveyMemberDayStatistics.html">考勤打卡查询</a>
						<a href="surveyMemberTimesStatistics.html">考勤打卡统计</a>
						<a href="jjlMng.html">车损事故报警量</a>
						<a href="workBriefingInfo.html">工作情况通报</a>
						<a href="handleCount.html">案件处理统计</a>
						<a href="accidentsCount.html">快处平台数据统计日报</a>
						<a href="accidentsMonthCount.html">快处平台数据统计月报</a>
						<a href="caseKcWarn.html">保险处理超时统计</a>
						<a href="statisticsView.html">大屏统计</a>
					</div>
				</dd>
			</dl>

			<dl>
				<dt><i class="ico ico-4"></i><span>系统设置</span></dt>
				<dd>
					<div class="scroll">
						<a href="rolesList.html">角色管理</a>
						<a href="smsContentList.html">警保短信模板</a>
						<a href="source.html">资源管理</a>
						<a href="showPage.html">job数据同步</a>
					</div>
				</dd>
			</dl>

			<dl>
				<dt><i class="ico ico-5"></i><span>快赔中心</span></dt>
				<dd>
					<div class="scroll">
						<a href="queryCase.html">快赔案件信息</a>
						<a href="queryKpPrivies.html">事故当事人信息</a>
						<a href="showKpDkCaseCount.html">代勘案件统计</a>
						<a href="showKpComCount.html">公司办理统计</a>
						<a href="showKpNetCount.html">网点办理统计</a>
						<a href="showKpCaseCount.html">受案登记统计</a>
						<a href="excaptionNoticeCount.html">事故频繁异常车辆预警</a>
						<a href="showPage2.html">快赔案件导出</a>
					</div>
				</dd>
			</dl>
		</div>
	</div>
</div>
<!-- header end -->



<!-- wrapper start -->
<div class="wrapper">
	<div class="filter">
		<button type="button" class="ubtn ubtn-cyan jsubmit" onclick="checkCaseAndSave()">提交</button>
	</div>
	<div class="editform">
		<div class="title">案件基本信息</div>
		<div class="form">
			<form action="#!" id="caseForm">
				<div class="item">
		            <div class="txt">事故时间</div>
		            <div class="cnt">
		            	<input class="ipt date" id="casetime" name="casetime" value="" placeholder="事故发生时间" type="text">
		            </div>
		        </div>
				<div class="item">
		            <div class="txt">事故地点</div>
		            <div class="cnt">
		            	<input id="longitude" name="longitude" value="" type="hidden">
		            	<input id="latitude" name="latitude" value="" type="hidden">
		            	<input id="accidentspotHidden" value="" type="hidden">
		            	<input class="ipt map" id="accidentspot" name="accidentspot" value="" type="text">
		            </div>
		        </div>
				<div class="item">
		            <div class="txt">事故辖区</div>
		            <div class="cnt">
		            	<select id="accidentstation" name="accidentstation" class="slt">
							<option value="">请选择</option>
							<option value="420102">江岸区</option>
							<option value="420103">江汉区</option>
							<option value="420104">硚口区</option>
						</select>
		            </div>
		        </div>	
				<div class="item">
		            <div class="txt">是否代勘</div>
		            <div class="cnt">
		            	<select id="proxyprospecting" name="proxyprospecting" class="slt">
							<option value="">请选择</option>
							<option value="1">是</option>
							<option value="0">否</option>
						</select>
		            </div>
		        </div>	
				<div class="item">
		            <div class="txt">代勘公司</div>
		            <div class="cnt">
		            	<select id="prospectingCom" name="prospectingCom" class="slt">
							<option value="">请选择</option>
							<option value="100">人保</option>
						</select>
		            </div>
		        </div>
				<div class="item">
		            <div class="txt">查勘员</div>
		            <div class="cnt">
		            	<input type="text" class="ipt" name="prospecter" />
		            </div>
		        </div>
				<div class="item">
		            <div class="txt">是否去过现场</div>
		            <div class="cnt">
		            	<select id="scene" name="scene" class="slt">
							<option value="0">否</option>
							<option value="1">是</option>
						</select>
		            </div>
		        </div>	
				<div class="item">
		            <div class="txt">协议书编号</div>
		            <div class="cnt">
		            	<input type="text" class="ipt" name="protocolnumber" />
		            </div>
		        </div>	
				<div class="item">
		            <div class="txt">定责书编号</div>
		            <div class="cnt">
		            	<input type="text" class="ipt" name="fixdutynumber" />
		            </div>
		        </div>
				<div class="item">
		            <div class="txt">交警姓名</div>
		            <div class="cnt">
		            	<input type="text" class="ipt" name="trafficpolice" />
		            </div>
		        </div>	
				<div class="item">
		            <div class="txt">快赔网点</div>
		            <div class="cnt">
		            	<select id="quickcompensate" name="quickcompensate" class="slt">
							<option value="1">龙众理赔点</option>
							<option value="2">红光理赔点</option>
							<option value="3">南众理赔点</option>
							<option value="4">胜东理赔点</option>
							<option value="10">优诚理赔点</option>
							<option value="6">九鼎理赔点</option>
							<option value="7">兴飞跃理赔点</option>
							<option value="8">高尔夫理赔点</option>
							<option value="9">龙城理赔点</option>
							<option value="5">盛强理赔点</option>
						</select>
		            </div>
		        </div>	
				<div class="item">
		            <div class="txt">备注</div>
		            <div class="cnt">
		            	<input type="text" class="ipt" name="memo" />
		            </div>
		        </div>		
		    </form>
		</div>
			

		<div class="title">
			<button type="button" class="ubtn ubtn-cyan" id="jadd">新增</button>
			事故当事人信息
		</div>

		<div id="newDataPage"></div>
		<script id="infoTemp" type="text/html">
			<div class="form">
				<form action="#!" id="dsrform{{id}}">
					<input name="id" value="{{id}}" type="hidden">
					<input name="caseId" value="{{caseId}}" type="hidden">
					<input name="originCode" value="{{xinzeng}}" type="hidden">
					<div class="item">
				           <div class="txt">事故当事人</div>
				           <div class="cnt">
				           	<input type="text" class="ipt" name="privies" value="{{privies}}" />
				           </div>
				       </div>	
					<div class="item">
				           <div class="txt">身份证号码</div>
				           <div class="cnt">
				           	<input type="text" class="ipt idcard" name="idcard" value="{{idcard}}" />
				           </div>
				       </div>
					<div class="item">
				           <div class="txt">其他证件号码</div>
				           <div class="cnt">
				           	<input type="text" class="ipt idcard" name="qtid" data-msg="" value="{{qtid}}" />
				           </div>
				       </div>	
					<div class="item">
				           <div class="txt">车牌号码</div>
				           <div class="cnt">
				           	<input type="text" class="ipt carPlate" name="carPlate" value="{{carPlate}}" />
				           </div>
				       </div>	
					<div class="item">
				           <div class="txt">报案号</div>
				           <div class="cnt">
				           	<input type="text" class="ipt carPlate" name="reportNumber" value="{{reportNumber}}" />
				           </div>
				       </div>	
					<div class="item">
				           <div class="txt">联系方式</div>
				           <div class="cnt">
				           	<input type="text" class="ipt" name="mobile" value="{{mobile}}" />
				           </div>
				       </div>	
					<div class="item">
				           <div class="txt">事故责任</div>
				           <div class="cnt">
				           	<select name="accidentRisk" class="slt">
				            	<option value="1">全责</option>
				           	</select>
				           </div>
				       </div>	
					<div class="item">
				           <div class="txt">所属保险公司</div>
				           <div class="cnt">
				           	<select name="insurer" class="slt">
				            	<option value="1">人保</option>
				           	</select>
				           </div>
				       </div>	
					<div class="item">
				           <div class="txt">估损金额</div>
				           <div class="cnt">
				           	<input type="text" class="ipt" name="gsje" value="{{gsje}}" />
				           </div>
				       </div>	
					<div class="item">
				           <div class="txt">是否留修</div>
				           <div class="cnt">
				           	<select name="stayRepair" class="slt">
				            	<option value="1">是</option>
				            	<option value="2">否</option>
				           	</select>
				           </div>
				       </div>	
					<div class="item">
				           <div class="txt">保险期限起</div>
				           <div class="cnt">
				           	<input type="text" class="ipt date" name="insurerStarStr" value="{{insurerStarStr}}" />
				           </div>
				       </div>	
					<div class="item">
				           <div class="txt">保险期限止</div>
				           <div class="cnt">
				           	<input type="text" class="ipt date readonly" name="insurerEndStr" readonly="readonly" value="{{insurerEndStr}}" />
				           </div>
				       </div>	
				       <div class="ft">
				           <button type="submit" class="ubtn ubtn-cyan jsave">保存</button>
				           <button type="button" class="ubtn ubtn-cyan jdel">删除</button>
				       </div>
				</form>
			</div>
		</script>

		<div class="title">图片信息</div>
		<div class="upimg">
            <button type="button" class="ubtn ubtn-cyan" id="jempty">清空图片</button>
            <span class="file ubtn ubtn-cyan">
            	<input type="file" />
            	选择图片
            </span>
            <span class="tips">（* 单次请上传10M以内的压缩包，如总图片大于10M，请分多个压缩包上传！）</span>
	   	</div>
	   	<div class="zip">
	   		<div class="tab">
				<span data-item="pic1" class="current">压缩包图片（0）</span>
			</div>
			<div class="tabcont">
				<div class="items" id="pic1" style="display: block;">
					<div class="zoompic">
						<img src="http://pija.hbia.org.cn:5555/hbjb-mng/fileinmix/getimage?time=208153&amp;model=6636db16126e5f78a4a8e62bbe37e755&amp;imageId=1394771&amp;type=0">
						<img src="http://pija.hbia.org.cn:5555/hbjb-mng/fileinmix/getimage?time=208153&amp;model=5747ca35775f026c100b870d9864b595&amp;imageId=1394772&amp;type=0">
					</div>
				</div>
			</div>
	   	</div>
	</div>
</div>
<!-- wrapper end -->

<div class="footer">
	<p>开发单位：湖北易站通达电子科技有限公司 </p>
</div>

<script src="assets/js/jquery191.js"></script>
<script src="assets/plugins/datetimepicker/core.js"></script>
<script src="assets/plugins/layer/layer.js"></script>
<script src="assets/plugins/select2/select2.js"></script>
<script src="assets/js/common.js"></script>
<script src="assets/js/md5.js"></script>
<script src="assets/js/art.template.js"></script>
<script>
	// 地图选点回调
	function mapCallback(pt, addComp) {
        $("#longitude").val(pt.lng);
        $("#latitude").val(pt.lat);
        $("#accidentspot").val(addComp.province + addComp.city  + addComp.district  + addComp.street +addComp.streetNumber);
        $("#accidentspotHidden").val($("#accidentspot").val());
        var msg = "您的位置是："+$("#accidentspot").val()+"<br/>";
        msg += "您的坐标是：经度："+$("#longitude").val()+",纬度："+$("#latitude").val()+"<br/>";
        msg += "是否确定？";
        fx.confirm(msg,function() {
            layer.closeAll();
        });
	}
	function checkCaseAndSave() {
		var longitude = $("#longitude").val();
		var latitude = $("#latitude").val();
		if(!longitude || !latitude){
			fx.confirm("请在地图上定位您的地址！",function (){
				$('#accidentspot').trigger('click');
			});
			return false;
		}
		var accidentspot = $("#accidentspot").val();
		var accidentspotHidden = $("#accidentspotHidden").val();
		if(accidentspot != accidentspotHidden){
			fx.confirm("地址发生变化，请重新在地图上定位您的地址！",function (){
				$('#accidentspot').trigger('click');
			});
			return false;
		}
		if(checkDsrIsChanged()!=0){
			if(checkDsrIsChanged()>0){
				fx.alert("有当事人信息尚未保存，请先保存后再提交");
			}else{
				fx.alert("至少应有一个当事人信息");
			}
		}else {
			saveCase();
		}
	}
	function checkDsrIsChanged(){
		var a = 0;
		$("#newDataPage").find("form").each(function() {
			var newCode = [],
				$form = $(this);
			newCode.push('privies' + $form.find("[name='privies']").val);
			newCode.push('idcard' + $form.find("[name='idcard']").val);
			newCode.push('qtid' + $form.find("[name='qtid']").val);
			newCode.push('carPlate' + $form.find("[name='carPlate']").val);
			newCode.push('reportNumber' + $form.find("[name='reportNumber']").val);
			newCode.push('mobile' + $form.find("[name='mobile']").val);
			newCode.push('accidentRisk' + $form.find("[name='accidentRisk']").val);
			newCode.push('insurer' + $form.find("[name='insurer']").val);
			newCode.push('gsje' + $form.find("[name='gsje']").val);
			newCode.push('stayRepair' + $form.find("[name='stayRepair']").val);
			newCode.push('insurerStarStr' + $form.find("[name='insurerStarStr']").val);
			newCode.push('insurerEndStr' + $form.find("[name='insurerEndStr']").val);
			if($form.find("[name='originCode']").val() != md5(newCode.join(''))){
				a ++;
			}
		})
		if (a > 0) {
			return a;
		} else {
			return -1;
		}
	}
	function saveCase(){
		var from = $("#caseForm").serialize();
		var picArray = new Array();
		var pics =  $("input[name^='imageId']");
		for(i=0;i<pics.length;i++){
			picArray.push(pics[i].name+"="+pics[i].value);
		}
		from = from + "&pics="+picArray.join("@");
		var url="hbjb/kpCase/saveKpCase";
		fx.request(url,from,function(datas){
			if(datas.code == "1"){
				fx.alert(datas.message);
				setTimeout(function(){
					var a='/hbjb-mng';
					var url=a+"/hbjb/kpCase/queryCase";
					window.location.href=url;
				},10);
			}else{
				fx.alert(datas.message);
				var data = datas.data;
				$.each(data,function(i,r){
					r = eval("("+r+")");
				});
			}
		})
		return false;
	}
	!(function($) {
		var _global = {
			init: function() {
				this.nav();
				this.select2();
				this.bindEvent();
			},
			nav: function() {
				$('.nav').find('dl').eq(4).addClass('active');
			},
			select2: function() {
				$('.slt').select2();
			},
			bindEvent: function() {
				var that  = this;
				this.formIdx = 1;

				$('#accidentspot').on('click', function() {
					var val = this.value;
					layer.open({
						type: 2,
						title: '查看地图',
						// shadeClose: true,
						area: ['670px', '555px'],
						content: ['map.html?region=' + escape(val) + '&s=' + (new Date).getTime(), 'no']
					})
				})

				// 新增
				$('#jadd').on('click', $.proxy(this.addDsr, this));

				// 保存
				$('#newDataPage').on('click', '.jsave', function(){
					that.valid(this);
					return false;
				});
				// 删除
				$('#newDataPage').on('click', '.jdel', function() {
					$(this).closest('.form').remove();
				})

				this.addDsr();
			},
			valid: function(el) {
				var $form          = $(el).closest('.form');
				var dsr            = $form.find("[name='privies']").val();
				var mobile         = $form.find("[name='mobile']").val();
				var accidentRisk   = $form.find("[name='accidentRisk']").val();
				var insurer        = $form.find("[name='insurer']").val();
				var gsje           = $form.find("[name='gsje']").val();
				var stayRepair     = $form.find("[name='stayRepair']").val();
				var insurerStarStr = $form.find("[name='insurerStarStr']").val();
				var insurerEndStr  = $form.find("[name='insurerEndStr']").val();
				var idcard         = $form.find("[name='idcard']").val();
				var qtid           = $form.find("[name='qtid']").val();
				var carPlate       = $form.find("[name='carPlate']").val();
				var reportNumber   = $form.find("[name='reportNumber']").val();
				if(dsr==""){
					fx.alert("当事人不能为空");
					return 1;
				}
		        if(mobile==""){
		            fx.alert("联系方式不能为空");
		            return 1;
		        }
				if(accidentRisk==""){
					fx.alert("事故责任不能为空");
					return 1;
				}
				if(insurer==""){
					fx.alert("保险公司不能为空");
					return 1;
				}
				if(gsje==""){
					fx.alert("估损金额不能为空");
					return 1;
				}
				if(idcard==""&&qtid==""){
					fx.alert("身份证号和其它证件号码必须有一个不能为空");
					return 1;
				}
				if(carPlate==""&&reportNumber==""){
					fx.alert("车牌号和报案号必须有一个不能为空");
					return 1;
				}
				if(insurerStarStr==""){
					fx.alert("保险期限起不能为空");
					return 1;
				}
				if(insurerEndStr==""){
					fx.alert("保险期限止不能为空");
					return 1;
				}
				if(isNaN(gsje)){
					fx.alert("估损金额必须为数字");
					return 1;
				}
				if(gsje.indexOf(".")>0){
					if(gsje.substr(0,gsje.indexOf(".")).length>8){
						fx.alert("估损金额整数部分最多只能有八位");
						return 1;
					}
					if(gsje.substr(gsje.indexOf(".")+1,gsje.length-1).length>2){
						fx.alert("估损金额最多只能有两位小数");
						return 1;
					}
				}else if(gsje.length>8){
					fx.alert("估损金额整数部分最多只能有八位");
					return 1;
				}
				if(reportNumber.length>30){
					fx.alert("报案号长度不能超过30位");
					return 1;
				}
				if(idcard.length>18){
					fx.alert("身份证号长度不能超过18位")
					return 1;
				}
				if(qtid.length>20){
					fx.alert("其它证件号长度不能超过20位")
					return 1;
				}
				if(carPlate.length>10){
					fx.alert("车牌号码长度不能超过10位");
					return 1;
				}
				if(mobile.length>11){
					fx.alert("联系方式长度不能超过11位");
					return 1;
				}
				if(dsr.length>5){
					fx.alert("当事人姓名不能超过5位");
					return 1;
				}
				return 0;
			},
			addDsr: function() {
				var data  = {
					id: this.formIdx++,
					caseId: '',
					xinzeng: 'xinzeng',
					privies: '',
					idcard: '',
					qtid: '',
					carPlate: '',
					reportNumber: '',
					mobile: '',
					gsje: '',
					insurerStarStr: '',
					insurerEndStr: ''
				}
				
				var model = template('infoTemp', data);
				$('#newDataPage').append(model);
				// $('#newDataPage').append(model.join(''));
				$('#dsrform' + this.formIdx).find('[name="insurerStarStr"]').datetimepicker({
			        format: 'yyyy-mm-dd'
			    }).on('changeDate', function(){
			    	var thistime = this.value;
					var thisyear = thistime.substr(0,4);
					var thisday = thistime.substr(4,6);
					var nextday = thisday;
					if(thisday == '-02-29'){//如果当前日期是2月29，那么加一年就会变成3月1日
						nextday = "-03-01";
					}
					var nextyear = parseInt(thisyear) + 1;
					$(this).closest('.item').next().find('[name="insurerEndStr"]').val(nextyear+nextday+" ")
			    })
			    $('#dsrform' + this.formIdx).find('.slt').select2();
			},
			setMD5Code: function(obj) {
				var $form = $(obj),
					val = [];
				val.push('privies' + $form.find("[name='privies']").val);
				val.push('idcard' + $form.find("[name='idcard']").val);
				val.push('qtid' + $form.find("[name='qtid']").val);
				val.push('carPlate' + $form.find("[name='carPlate']").val);
				val.push('reportNumber' + $form.find("[name='reportNumber']").val);
				val.push('mobile' + $form.find("[name='mobile']").val);
				val.push('accidentRisk' + $form.find("[name='accidentRisk']").val);
				val.push('insurer' + $form.find("[name='insurer']").val);
				val.push('gsje' + $form.find("[name='gsje']").val);
				val.push('stayRepair' + $form.find("[name='stayRepair']").val);
				val.push('insurerStarStr' + $form.find("[name='insurerStarStr']").val);
				val.push('insurerEndStr' + $form.find("[name='insurerEndStr']").val);
				$form.find("[name='originCode']").val(md5(val.join('')));
			}
		}
		_global.init();
	})(jQuery);
</script>
</body>
</html>