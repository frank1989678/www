<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>报表统计</title>
    <meta name="renderer" content="webkit" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="stylesheet" href="assets/plugins/select2/select2.css" />
</head>
<body>

<!-- header begin -->
<div class="header cf">
	<div class="logo">
		<a href="index.html">交通事故快速处理平台</a>
	</div>
	<div class="user">
		<div class="online">在线用户数：8人</div>
		<dl>
			<dt><i class="ico ico-user"></i>系统管理员</dt>
			<dd>
				<a href="javascript:;" id="jmodifyPwd">修改密码</a>
				<a href="login.html">安全退出</a>
			</dd>
		</dl>
	</div>
</div>
<!-- header end -->

<div class="nav cf">
	<ul>
		<li><a href="index.html"><i class="ico ico-1"></i>首页</a></li>
		<li><a href="sgdz.html"><i class="ico ico-2"></i>事故定责</a></li>
		<li>
			<dl>
				<dt><i class="ico ico-3"></i>系统设置</dt>
				<dd>
					<a href="user.html">用户管理</a>
					<a href="role.html">角色管理</a>
					<a href="area.html">用户区域设置</a>
					<a href="source.html">资源管理</a>
				</dd>
			</dl>
		</li>
		<li>
			<dl>
				<dt><i class="ico ico-3"></i>报表统计</dt>
				<dd>
					<a href="statis.html">报表统计</a>
					<a href="accident-his.html">历史事故查询</a>
					<a href="accident.html">事故查询</a>
				</dd>
			</dl>
		</li>
	</ul>
</div>

<div class="wrapper">
	<div class="filter">
		<form onsubmit="return false" name="filter" id="filter">
			<label class="for">统计时间</label>
			<input type="text" class="ipt date" name="start1" id="queryStartTime"  />
			<i>-</i>
			<input type="text" class="ipt date" name="end1" id="queryEndTime"  />

			<label class="for">统计维度</label>
			<span class="radio-group">
				<input type="hidden" name="orderType" value="1">
				<em data-value="1" class="on">按时间事故统计</em>
				<em data-value="2">按区域事故统计</em>
				<em data-value="3">按公司事故统计</em>
			</span>
		</form>
	</div>

	<div class="box">
		<div class="tab">
			<span class="on">表格模式</span>
			<span>图表模式</span>
		</div>
		
		<div class="mt15 tab-cont">
			<div class="table">
				<table>
					<thead id="thead"></thead>
					<tbody id="tbody"></tbody>
					<tfoot id="tfoot"></tfoot>
				</table>
			</div>
			
			<div class="chart4 hide" id="chart4"></div>
		</div>

		
		<div class="operate">
			<div class="pagination"></div>
		</div>
	</div>

</div>

<!-- 公用 -->
<script src="assets/js/jquery191.js"></script>
<script src="assets/plugins/layer/layer.js"></script>
<script src="assets/js/common.js"></script>

<!-- 页面专用 -->
<link rel="stylesheet" href="assets/plugins/jedate/jedate.css" />
<script src="assets/js/art.template.js"></script>
<script src="assets/js/ajaxPage.js"></script>
<script src="assets/plugins/jedate/jquery.jedate.min.js"></script>
<script src="assets/js/echarts.min.js"></script>

<!-- 拦截ajax请求并返回虚拟数据(只做演示使用，开发时请删除) -->
<script src="assets/js/mock.js"></script>
<script>
	Mock.mock('http://g.cn', {
		"result": "SUCCESS",
	    "totalSize": 18,
	    "list1": [{"groupValue":"2017-09-01","allCount":183,"waitCount":0,"dutyCount":169,"bugCount":14,"finishCount":0,"underCount":0},{"groupValue":"2017-09-02","allCount":207,"waitCount":0,"dutyCount":190,"bugCount":17,"finishCount":0,"underCount":0},{"groupValue":"2017-09-03","allCount":182,"waitCount":0,"dutyCount":163,"bugCount":19,"finishCount":0,"underCount":0},{"groupValue":"2017-09-04","allCount":203,"waitCount":0,"dutyCount":188,"bugCount":15,"finishCount":0,"underCount":0},{"groupValue":"2017-09-05","allCount":192,"waitCount":0,"dutyCount":170,"bugCount":22,"finishCount":0,"underCount":0},{"groupValue":"2017-09-06","allCount":189,"waitCount":0,"dutyCount":179,"bugCount":10,"finishCount":0,"underCount":0},{"groupValue":"2017-09-07","allCount":231,"waitCount":0,"dutyCount":207,"bugCount":24,"finishCount":0,"underCount":0},{"groupValue":"2017-09-08","allCount":232,"waitCount":0,"dutyCount":203,"bugCount":29,"finishCount":0,"underCount":0},{"groupValue":"2017-09-09","allCount":205,"waitCount":0,"dutyCount":188,"bugCount":17,"finishCount":0,"underCount":0},{"groupValue":"2017-09-10","allCount":181,"waitCount":0,"dutyCount":160,"bugCount":21,"finishCount":0,"underCount":0}],
	    "list2": [{"allCount":420,"waitCount":44,"underCount":44,"dutyCount":399,"bugCount":21,"groupValue":"江岸区"},{"allCount":443,"waitCount":0,"underCount":0,"dutyCount":423,"bugCount":20,"groupValue":"江汉区",},{"allCount":326,"waitCount":0,"underCount":0,"dutyCount":313,"bugCount":13,"groupValue":"硚口区",},{"allCount":291,"waitCount":0,"underCount":0,"dutyCount":251,"bugCount":40,"groupValue":"汉阳区",},{"allCount":869,"waitCount":0,"underCount":0,"dutyCount":835,"bugCount":34,"groupValue":"武昌区",},{"allCount":666,"waitCount":0,"underCount":1,"dutyCount":582,"bugCount":83,"groupValue":"洪山",},{"allCount":186,"waitCount":0,"underCount":0,"dutyCount":154,"bugCount":32,"groupValue":"青山区",},{"allCount":473,"waitCount":0,"underCount":1,"dutyCount":392,"bugCount":80,"groupValue":"东湖新技术开发区",},{"allCount":184,"waitCount":0,"underCount":0,"dutyCount":141,"bugCount":43,"groupValue":"武汉经济技术开发区",},{"allCount":52,"waitCount":1,"underCount":0,"dutyCount":47,"bugCount":4,"groupValue":"东湖生态旅游风景区",}],
	    "list3": [{"tzCount":3,"qzCount":9,"zzCount":1,"czCount":0},{"tzCount":15,"qzCount":108,"groupValue":"中华联合","zzCount":5,"czCount":13},{"tzCount":0,"qzCount":9,"groupValue":"中银保险","zzCount":0,"czCount":0},{"tzCount":2,"qzCount":44,"groupValue":"亚太产险","zzCount":3,"czCount":0},{"tzCount":110,"qzCount":1238,"groupValue":"人保财险","zzCount":41,"czCount":39},{"tzCount":0,"qzCount":7,"groupValue":"信达产险","zzCount":0,"czCount":0},{"tzCount":1,"qzCount":23,"groupValue":"华安产险","zzCount":0,"czCount":0},{"tzCount":0,"qzCount":17,"groupValue":"华泰产险","zzCount":0,"czCount":1},{"tzCount":2,"qzCount":21,"groupValue":"国元","zzCount":1,"czCount":2},{"tzCount":3,"qzCount":75,"groupValue":"国寿财险","zzCount":2,"czCount":4}]
	});
	Mock.mock('http://r.cn', {
		"result": "SUCCESS",
	    "reasons": [
		    {"resion":"重复报警","number":6},
		    {"resion":"单方事故","number":1},
		    {"resion":"证件不全","number":3},
		    {"resion":"电话错误","number":2},
		    {"resion":"有争议","number":1},
		    {"resion":"测试","number":2},
		    {"resion":"图片拍摄不合要求","number":1},
		    {"resion":"未知","number":5}
	    ]
	});
</script>
<!-- 拦截ajax请求并返回虚拟数据(只做演示使用，开发时请删除) end -->


<script>
var myChart;
var colors = ['#a9c7ff', '#f3a43b','#b5c334','#60c0dd','#C1232B','#FE8463','#9BCA63','#FAD860','#F3A43B','#60C0DD', '#D7504B','#C6E579','#F4E001','#F0805A','#26C0C0'];
var orderType = '1';
function showDetailReason(e){
    var czCount = $(e).attr('czCount');
    var datanew = {};
    if(czCount == 0 || czCount == null){
        return;
    }
    datanew.orderType    = orderType;
    datanew.regStartTime = $("#queryStartTime").val();
    datanew.regEndTime   = $("#queryEndTime").val();
    datanew.groupValue   = $(e).attr("groupvalue");
    $.ajax({
    	url: 'http://r.cn',
    	data: datanew,
    	type: 'POST',
    	dataType: 'json',
    	success: function(res) {
    		if(res.result == "SUCCESS"){
    			var content = ['<ul class="abnormal">'];
    			content.push('<li class="hd"><span>数量</span><em>原因</em></li>');
    			$.each(res.reasons, function(i, item) {
    				content.push('<li><span>', item.number,'</span><em>', item.resion, '</em></li>');
    			})
    			content.push('</ul>')
    			layer.tips(content.join(''), e, {shift: -1, time: 0, tips: [1, '#5a9bd5']});
	        }else{
	           $.notify({
	           		'type': 'warning',
	           		'title': '暂无数据'
	           })
	        }
    	}
    })
}

function initChart1(data) {
	var x_data = [],
		y_data = [],
		tooltip = {},
		thead = ['日期','事故总数','待处理','处理中','定责完成','异常关闭'],
		total = ['总合计', 0, 0, 0, 0, 0],
		table = [];

	$.each(data, function(i, item) {
		var model = [];
		model.push('<dl class="chart-dl">');
		model.push('<dt>' + item.groupValue + '</dt>');
		model.push('<dd><i style="background:', colors[0],'"></i>事故总数: ' + item.allCount + '</dd>');
        model.push('<dd><i style="background:', colors[1],'"></i>待处理: ' + item.waitCount  + '</dd>');
        model.push('<dd><i style="background:', colors[2],'"></i>处理中: ' + item.underCount  + '</dd>');
        model.push('<dd><i style="background:', colors[3],'"></i>定责完成: ' + item.dutyCount + '</dd>');
        model.push('<dd><i style="background:', colors[4],'"></i>异常关闭: ' + item.bugCount  + '</dd>');
        model.push('</dl>');
		tooltip[item.groupValue] = model.join('');

        table.push('<tr>');
        table.push('<td>' + item.groupValue + '</td>');
        table.push('<td>' + item.allCount + '</td>');
        table.push('<td>' + item.waitCount + '</td>');
        table.push('<td>' + item.underCount + '</td>');
        table.push('<td>' + item.dutyCount + '</td>');
        table.push('<td><span class="showDetail" groupvalue="' + item.groupValue + '" czcount="' + item.bugCount + '" onclick="showDetailReason(this)">' + item.bugCount + '</span></td>');
        table.push('</tr>');

        total[1] += item.allCount;
        total[2] += item.waitCount;
        total[3] += item.underCount;
        total[4] += item.dutyCount;
        total[5] += item.bugCount;

		x_data.push(item.groupValue);
        y_data.push(item.allCount);
	})
	total[5] = '<span class="showDetail" groupvalue="total" czcount="' + total[5] + '" onclick="showDetailReason(this)">' + total[5] + '</span>';

	$('#thead').html('<tr><th>' + thead.join('</th><th>') + '</th></tr>');
	$('#tbody').html(table.join(''));
	$('#tfoot').html('<tr><th>' + total.join('</th><th>') + '</th></tr>');

	myChart.setOption({
		title: {
			text: '处理事故数',
			top: 10,
			right: 20,
			textStyle: {
				color: colors[0],
				fontSize: 14
			}
		},
		tooltip: {
	        trigger: 'axis',
	        formatter: function (params, ticket, callback) {
	        	return tooltip[params[0].name];
	        }
	    },
	    backgroundColor: '#fff',
	    grid: {
	        left: '3%',
	        right: '3%',
	        bottom: '3%',
	        containLabel: true,
	        borderWidth: 0
	    },
	    xAxis: {
	        axisLine: {
	            lineStyle: {
	            	color: colors[0],
	            	width: 2
	            }
	        },
	        axisLabel: {
	        	textStyle: {
				    color: function (value, index) {
				        return index%2 === 0 ? '#5a738e' : '#eb9335';
				    }
				}
	        },
	        data: x_data
	    },
	    yAxis: {
	        axisLine: {
	            lineStyle: {
	            	color: colors[0],
	            	width: 2
	            }
	        },
	        axisLabel: {
	        	textStyle: {
	        		color: '#5a738e'
	        	}
	        },
	    	scale : true,
	    	splitLine: {
	    		lineStyle: {
	    			color: '#e6ecf9'
	    		}
	    	}
	    },
	    series: {
	        name: '处理事故数',
	        type: 'line',
	        itemStyle: {
	        	normal: {
	        		borderWidth: 5,
	        		color: '#ffa511'
	        	}
	        },
	        lineStyle: {
	        	normal: {
	        		color: '#ffa511',
	        		opacity: 0.53,
	        		width: 3
	        	}
	        },
	        areaStyle: {
	        	normal: {
	        		color: '#ffa511',
	        		opacity: 0.09
	        	}
	        },
	        data: y_data
	    }
	}, true);
}

function initChart2(data) {
	var x_data = [],
		y_allCount = [],
		y_waitCount = [],
		y_underCount = [],
		y_dutyCount = [],
		y_bugCount = [],
		thead = ['区域名称','事故总数','待处理','处理中','定责完成','异常关闭'],
		total = ['总合计', 0, 0, 0, 0, 0],
		table = [];

	$.each(data, function(i, item) {
		x_data.push(item.groupValue)
		y_allCount.push(item.allCount);
		y_waitCount.push(item.waitCount);
		y_underCount.push(item.underCount);
		y_dutyCount.push(item.dutyCount);
		y_bugCount.push(item.bugCount);

        table.push('<tr>');
        table.push('<td>' + item.groupValue + '</td>');
        table.push('<td>' + item.allCount + '</td>');
        table.push('<td>' + item.waitCount + '</td>');
        table.push('<td>' + item.underCount + '</td>');
        table.push('<td>' + item.dutyCount + '</td>');
        table.push('<td><span class="showDetail" groupvalue="' + item.groupValue + '" czcount="' + item.bugCount + '" onclick="showDetailReason(this)">' + item.bugCount + '</span></td>');
        table.push('</tr>');

        total[1] += item.allCount;
        total[2] += item.waitCount;
        total[3] += item.underCount;
        total[4] += item.dutyCount;
        total[5] += item.bugCount;
	})
	total[5] = '<span class="showDetail" groupvalue="total" czcount="' + total[5] + '" onclick="showDetailReason(this)">' + total[5] + '</span>';

	$('#thead').html('<tr><th>' + thead.join('</th><th>') + '</th></tr>');
	$('#tbody').html(table.join(''));
	$('#tfoot').html('<tr><th>' + total.join('</th><th>') + '</th></tr>');

	myChart.setOption({
		title: {
	        text: '区域事故统计'
	    },
	    color: colors,
	    tooltip: {
	        trigger: 'axis',
	        axisPointer: {
	            type: 'shadow'
	        }
	    },
	    grid: {
	        left: '3%',
	        right: '4%',
	        bottom: '3%',
	        containLabel: true
	    },
	    barMaxWidth: 6,
	    yAxis: {},
	    xAxis: {
            type : 'category',
            axisLabel: {show:true,clickable: true, rotate:0, margin: 8, interval: 0},
            data: x_data
        },
	    series: [{
            name: '事故总数',
            type: 'bar',
            data: y_allCount
        }, {
            name: '待处理',
            type: 'bar',
            data: y_waitCount
        }, {
            name: '处理中',
            type: 'bar',
            data: y_underCount
        }, {
            name: '定责完成',
            type: 'bar',
            data: y_dutyCount
        }, {
            name: '异常关闭',
            type: 'bar',
            data: y_bugCount
        }]
	}, true);
}

function initChart3(data) {
	var x_data = [],
		y_allCount = [],
		y_qzCount = [],
		y_zzCount = [],
		y_tzCount = [],
		y_czCount = [],
		thead = ['公司','事故总数','全责','主责','同责','次责'],
		total = ['总合计', 0, 0, 0, 0, 0],
		table = [];

	$.each(data, function(i, item) {
		var allCount = item.qzCount+item.zzCount+item.tzCount+item.czCount;
		x_data.push(item.groupValue || '');
		y_allCount.push(allCount);
		y_qzCount.push(item.qzCount);
		y_zzCount.push(item.zzCount);
		y_tzCount.push(item.tzCount);
		y_czCount.push(item.czCount);

        table.push('<tr>');
        table.push('<td>' + (item.groupValue || '') + '</td>');
        table.push('<td>' + allCount + '</td>');
        table.push('<td>' + item.qzCount + '</td>');
        table.push('<td>' + item.zzCount + '</td>');
        table.push('<td>' + item.tzCount + '</td>');
        table.push('<td>' + item.czCount + '</td>');
        // table.push('<td><span class="showDetail" groupvalue="' + item.groupValue + '" czcount="' + item.czCount + '" onclick="showDetailReason(this)">' + item.czCount + '</span></td>');
        table.push('</tr>');

        total[1] += allCount;
        total[2] += item.qzCount;
        total[3] += item.zzCount;
        total[4] += item.tzCount;
        total[5] += item.czCount;
	})

	$('#thead').html('<tr><th>' + thead.join('</th><th>') + '</th></tr>');
	$('#tbody').html(table.join(''));
	$('#tfoot').html('<tr><th>' + total.join('</th><th>') + '</th></tr>');

	myChart.setOption({
		title: {
	        text: '公司事故统计'
	    },
	    color: colors,
	    tooltip: {
	        trigger: 'axis',
	        axisPointer: {
	            type: 'shadow'
	        }
	    },
	    grid: {
	        left: '3%',
	        right: '4%',
	        bottom: '3%',
	        containLabel: true
	    },
	    barMaxWidth: 6,
	    yAxis: {},
	    xAxis: {
            type : 'category',
            axisLabel: {show:true,clickable: true, rotate:0, margin: 8, interval: 0},
            data: x_data
        },
    	series: [{
            name: '事故总数',
            type: 'bar',
            data: y_allCount
        }, {
            name: '全责',
            type: 'bar',
            data: y_qzCount
        }, {
            name: '主责',
            type: 'bar',
            data: y_zzCount
        }, {
            name: '同责',
            type: 'bar',
            data: y_tzCount
        }, {
            name: '次责',
            type: 'bar',
            data: y_czCount
        }]
	}, true);
}
var _global = {
	init: function() {
		this.bindEvent();
		this.jeDate();
		this.chart();
		this.filter();
	},
	filter: function() {
		var that = this;
		var $form = $('#filter');
		var page =  new Page({
			pageIndex: 1, // 当前页
			pageSize: 10, // 每页显示10条
			url: 'http://g.cn',
			data: $form.serializeArray(),
			callback: function(res) {
				if (orderType == 1) {
					initChart1(res.list1);
				} else if (orderType == 2) {
					initChart2(res.list2);
				} else if (orderType == 3) {
					initChart3(res.list3);
				}
			}
		})

		$form.find('input[name="orderType"]').val(orderType);
		
		// 查询
		$form.on('submit', function() {
			var filterData = $form.serializeArray();
			var start1 = $('#queryStartTime').val();
			var end1 = $('#queryEndTime').val();
			var t1 = new Date(start1.replace(/-/g, '/'));
			var t2 = new Date(end1.replace(/-/g, '/'));
			t1.setMonth(t1.getMonth() + 1);
        	if (t2.getTime() > t1.getTime()) {
        		$.notify({
        			type: 'warning',
        			title: '请选择1个月之内的时间段查看统计'
        		})
        		return false;
        	}
			page.request(true, filterData);
			return false;
		})

		$form.on('click', '.radio-group em', function() {
			orderType = $(this).data('value');
			$(this).siblings('input').val(orderType);
			$(this).addClass('on').siblings().removeClass('on');
			$form.trigger('submit');
		})
	},
	jeDate: function() {
		$.mydate({
            start: '#queryStartTime',
            end: '#queryEndTime',
            format: 'YYYY-MM-DD',
            isinitVal: true
        })
	},
	bindEvent: function() {
		var that = this;
		$('.tab').on('click', 'span', function() {
			var idx = $(this).index();
			$(this).addClass('on').siblings().removeClass('on');
			$('.tab-cont').children().eq(idx).show().siblings().hide();
			idx === 1 && myChart.resize();
		})
        // 异常关闭详情
        $('body').on('click', function() {
        	layer.closeAll('tips');
        })
	},
	chart: function() {
		var timer = 0;
		myChart = echarts.init(document.getElementById('chart4'));
        var chartReset = function() {
        	clearTimeout(timer);
        	timer = setTimeout(function() {
        		myChart.resize();
        	}, 50)
        }
        $(window).on('resize', chartReset);
	}
}
</script>
</body>
</html>