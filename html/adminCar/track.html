<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>车辆监控</title>
    <meta name="renderer" content="webkit" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="stylesheet" href="assets/plugins/zTreeStyle/jquery.ztree.css" />
    <link rel="stylesheet" href="assets/plugins/date/daterangepicker.min.css" />
    <script src="assets/js/jquery191.js"></script>
</head>
<body>

<!-- header begin -->
<div class="header cf">
	<div class="logo">
		<a href="index.html">武汉119作战指挥中心调度平台</a>
	</div>
	<div class="nav">
		<ul>
			<li>
				<dl>
					<dt><i class="ico ico-1"></i>地图管控</dt>
					<dd>
						<a href="track.html">车辆监控</a>
						<a href="dispatcherManage.html">调度管理</a>
						<a href="trackHis.html">历史轨迹</a>
						<a href="railManage.html">电子围栏</a>
					</dd>
				</dl>
			</li>
			<li>
				<dl>
					<dt><i class="ico ico-4"></i>系统管理</dt>
					<dd>
						<a href="carManage.html">车辆管理</a>
						<a href="orgManage.html">机构管理</a>
						<a href="userManage.html">用户管理</a>
						<a href="roleManage.html">角色管理</a>
						<a href="purviewManage.html">权限管理</a>
					</dd>
				</dl>
			</li>
		</ul>
	</div>
	<div class="user">
		<span>yitop</span>
		<i>|</i>
		<a href="javascript:;" id="mdyPwd">修改密码</a>
		<i>|</i>
		<a href="login.html" class="ico ico-logout"></a>
	</div>
</div>
<!-- header end -->

<div class="map" id="map"></div>

<div class="side" id="side">
    <div class="tit">
        <button type="button" onclick="getCarTree(0,0,0,0)" class="ico ico-refresh"></button>
        车辆列表
    </div>
    <div class="search">
        <form name="search">
            <label>车牌号</label>
            <input type="text" class="ipt" placeholder="请输入车牌号" onkeyup="searchCar(this)">
            <button type="button" class="ico ico-search"></button>
        </form>
        <div class="choose" id="autoSearch"></div>
    </div>
    <div class="tools">
        <button type="button" class="tooltip ico ico-1 active" onclick="getCarTree(0,0,0, 0)" data-tips="全部"></button>
        <button type="button" class="tooltip ico ico-2" onclick="getCarTree(2,0,0, 1)" data-tips="在线"></button>
        <button type="button" class="tooltip ico ico-3" onclick="getCarTree(1,0,0, 2)" data-tips="离线"></button>
    </div>
    <div class="open"></div>
    <ul id="carTree" class="ztree"></ul>
</div>

<script>
var cars = {};
var treeTimer;
// 获取小车树形菜单
function getTree(data) {
    if (typeof window.setting === 'undefined') {
        return;
    }
    $.ajax({
        url: '/carMonitor/getTree',
        url: 'json/carTree.json',
        dataType: 'json',
        data: data,
        success: function(res) {
            $.fn.zTree.destroy('carTree');
            $.each(res || {}, function(i, item) {
                if (cars[item.id]) {
                    item.checked = true;
                }
                item.open = true; // 展开节点
            })
            var treeObj = $.fn.zTree.init($('#carTree'), setting, res);

            var carUrl = location.search;//获取url中“？”符后的字串
            if(carUrl.indexOf("?") != -1){
                var node = treeObj.getNodeByParam("id","${param.id}");
                treeObj.checkNode(node,true,false);
                var pageName = "${param.pageName}";
                if(pageName=='carPositionRecord'){
                    $("#carCode1").html('轨迹筛找（'+node.name+'）');
                }else if(pageName=='dispatchRecord'){
                    $("#jcar").val(node.name);
                    $("#jcarId").val(node.id);
                }else if(pageName=='ocxMonitor'){
                    treeObj.selectNode(node);
                    _getVideoInfo(node.id,"flag");
                }
            }
        },
        error: function() {
            $.notify({
                type: 'danger',
                title: '数据加载失败!'
            })
        }
    })
}

// 获取小车树形菜单
function getCarTree(carStatus, efStatus,actionStatus,idx) {
    // 导航高亮
    $('#side').find('.tools .ico').eq(idx).addClass('active').siblings().removeClass('active');
    getTree({
        carStatus: carStatus,
        efStatus: efStatus,
        actionStatus:actionStatus
    });
    autoRefreshCarTree(true);
}

/**
 * 自动刷新车辆类表
 * @param {Boolean} refresh 是否自动刷新
 */
function autoRefreshCarTree(refresh) {
    treeTimer && clearTimeout(treeTimer);
    if (refresh) {
        treeTimer = setTimeout(function(){
            $('#side').find('.tools .active').trigger('click');
        }, 30 * 1000);
    }
}

$(function() {
    getCarTree(0,0,0,0);

    // 鼠标在车辆列表上时关闭自动刷新
    $('#side').on('mouseenter', function() {
        autoRefreshCarTree();
    }).on('mouseleave', function() {
        autoRefreshCarTree(true);
    })
})

// 搜索车牌号
function searchCar(el) {
    var carNumber = el.value,
        zTree, treeNode, model = [];

    if (carNumber != '') {
        zTree = $.fn.zTree.getZTreeObj('carTree');
        treeNode = zTree.getNodesByParamFuzzy('name', carNumber);
        $.each(treeNode, function(i, item) {
            model.push('<span onclick="selectCar(' + item.id + ')">' + item.name + '</span>');
        })
    }
    $('#autoSearch').html(model.join('')).show();
}

// 搜索定位
function selectCar(carId) {
    var zTree = $.fn.zTree.getZTreeObj('carTree');
    var node = zTree.getNodeByParam('id', carId);
    zTree.cancelSelectedNode(false);
    zTree.selectNode(node, true);
}
</script>

<div class="side" id="side4">
    <button type="button" class="tooltip ico ico-1" data-tips="路况" id="traffic"></button>
</div>


<div class="footer-fix">
    <span>湖北省宏锐慧通信息技术有限公司</span>
</div>

<!-- 点击小车详情模板 -->
<script id="carTemp" type="text/html">
    <div class="layer-detail">
        <ul class="ul1">
            <li><label>车辆类型：</label><em>{{carUse}}</em></li>
            <li><label>使用机构：</label><em>{{agencyName}}</em></li>
            <li><label>设备IMEI：</label><em>{{IMEI}}</em></li>
            <li><label>版本类型：</label><em>{{deviceType}}</em></li>
            <li><label>SIM卡手机号：</label><em>{{terminalSim}}</em></li>
            <li><label>使用人姓名：</label><em>{{carUsername}}</em></li>
            <li><label>使用人电话：</label><em>{{carUserPhone}}</em></li>
        </ul>
        <ul class="ul2">
            <li><label>车辆在线状态：</label><em>{{carStatus}}</em></li>
            <li><label>GPS上报时间：</label><em>{{registerTime}}</em></li>
            <li><label>GPS速度：</label><em>{{speed}}</em></li>
            <li><label>GPS地址：</label><em id="carPosition">{{carPosition}}</em></li>
            <li><label>车辆当日里程：</label><em>{{distance}}km</em></li>
        </ul>
        <div class="clear"></div>
        {{if carStatus === '在线'}}
        <div class="btm tc">
            <button type="button" class="ubtn ubtn-primary fr">一键抓拍</button>
            <a href="/carPositionRecord/manager?id={{carId}}&pageName=carPositionRecord" class="ubtn ubtn-primary fl">历史轨迹</a>
            <a href="/dispatchRecord/manager?id={{carId}}&pageName=dispatchRecord" class="ubtn ubtn-primary">调度管理</a>
        </div>
        {{/if}}
        {{if actionStatus != '未出警'}}
        <div class="dynamic hide">
            <div class="hd">出警动态<i class="fold"></i></div>
            <div class="bd">
                <ul class="ul1">
                    <li>立案时间：{{asRegisterTime}}</li>
                    <li>燃烧对象：{{asBurnObject}}
                    </li>
                    <li>案发地点：{{asAddress}}</li>
                    <li>距离现场距离：{{distance}}</li>
                </ul>
                <ul class="ul2">
                    <li>类别：{{asType}}</li>
                    <li>级别：{{asLevel}}</li>
                    <li>车辆出警状态：{{actionStatus}}</li>
                    <li>预计到场时间：{{minute}}</li>
                </ul>
            </div>
        </div>
        {{/if}}
    </div>
</script>
<!-- end 点击小车详情模板 -->


<!-- 公用 -->
<script src="assets/plugins/layer/layer.js"></script>
<script src="assets/plugins/date/daterangepicker.min.js"></script>
<script src="assets/plugins/zTreeStyle/jquery.ztree.min.js"></script>
<script src="assets/js/art.template.js"></script>
<script src="assets/js/common.js"></script>
<script src="http://webapi.amap.com/maps?v=1.3&key=9d870244cd940650899a73c0566d7652&plugin=AMap.Autocomplete,AMap.PlaceSearch,AMap.Geocoder"></script>
<script src="assets/js/gaode.tools.js"></script>
<script src="assets/js/textcode.js"></script>
<script src="assets/app/monitor.js"></script>

</body>
</html>