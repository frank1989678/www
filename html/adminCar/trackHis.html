<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>历史轨迹</title>
    <meta name="renderer" content="webkit" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="stylesheet" href="assets/plugins/zTreeStyle/jquery.ztree.css" />
    <link rel="stylesheet" href="assets/plugins/date/daterangepicker.min.css" />
    <script src="assets/js/jquery191.js"></script>
</head>
<body>

<!-- header begin -->
<div class="header cf">
	<div class="logo">
		<a href="index.html">武汉119作战指挥中心调度平台</a>
	</div>
	<div class="nav">
		<ul>
			<li>
				<dl>
					<dt><i class="ico ico-1"></i>地图管控</dt>
					<dd>
						<a href="track.html">车辆监控</a>
						<a href="dispatcherManage.html">调度管理</a>
						<a href="trackHis.html">历史轨迹</a>
						<a href="railManage.html">电子围栏</a>
					</dd>
				</dl>
			</li>
			<li>
				<dl>
					<dt><i class="ico ico-4"></i>系统管理</dt>
					<dd>
						<a href="carManage.html">车辆管理</a>
						<a href="orgManage.html">机构管理</a>
						<a href="userManage.html">用户管理</a>
						<a href="roleManage.html">角色管理</a>
						<a href="purviewManage.html">权限管理</a>
					</dd>
				</dl>
			</li>
		</ul>
	</div>
	<div class="user">
		<span>yitop</span>
		<i>|</i>
		<a href="javascript:;" id="mdyPwd">修改密码</a>
		<i>|</i>
		<a href="login.html" class="ico ico-logout"></a>
	</div>
</div>
<!-- header end -->

<div class="map" id="map"></div>

<div class="side" id="side">
    <div class="tit">
        <button type="button" onclick="getCarTree(0,0,0,0)" class="ico ico-refresh"></button>
        车辆列表
    </div>
    <div class="search">
        <form name="search">
            <label>车牌号</label>
            <input type="text" class="ipt" placeholder="请输入车牌号" onkeyup="searchCar(this)">
            <button type="button" class="ico ico-search"></button>
        </form>
        <div class="choose" id="autoSearch"></div>
    </div>
    <div class="tools">
        <button type="button" class="tooltip ico ico-1 active" onclick="getCarTree(0,0,0, 0)" data-tips="全部"></button>
        <button type="button" class="tooltip ico ico-2" onclick="getCarTree(2,0,0, 1)" data-tips="在线"></button>
        <button type="button" class="tooltip ico ico-3" onclick="getCarTree(1,0,0, 2)" data-tips="离线"></button>
    </div>
    <div class="open"></div>
    <ul id="carTree" class="ztree"></ul>
</div>

<script>
var cars = {};
var treeTimer;
// 获取小车树形菜单
function getTree(data) {
    if (typeof window.setting === 'undefined') {
        return;
    }
    $.ajax({
        url: '/carMonitor/getTree',
        url: 'json/carTree.json',
        dataType: 'json',
        data: data,
        success: function(res) {
            $.fn.zTree.destroy('carTree');
            $.each(res || {}, function(i, item) {
                if (cars[item.id]) {
                    item.checked = true;
                }
                item.open = true; // 展开节点
                if (setting.pcheck === false && !item.iconSkin) {
                	// item.chkDisabled = true;
                	item.nocheck = true;
                }
            })
            var treeObj = $.fn.zTree.init($('#carTree'), setting, res);

            var carUrl = location.search;//获取url中“？”符后的字串
            if(carUrl.indexOf("?") != -1){
                var node = treeObj.getNodeByParam("id","${param.id}");
                treeObj.checkNode(node,true,false);
                var pageName = "${param.pageName}";
                if(pageName=='carPositionRecord'){
                    $("#carCode1").html('轨迹筛找（'+node.name+'）');
                }else if(pageName=='dispatchRecord'){
                    $("#jcar").val(node.name);
                    $("#jcarId").val(node.id);
                }else if(pageName=='ocxMonitor'){
                    treeObj.selectNode(node);
                    _getVideoInfo(node.id,"flag");
                }
            }
        },
        error: function() {
            $.notify({
                type: 'danger',
                title: '数据加载失败!'
            })
        }
    })
}

// 获取小车树形菜单
function getCarTree(carStatus, efStatus,actionStatus,idx) {
    // 导航高亮
    $('#side').find('.tools .ico').eq(idx).addClass('active').siblings().removeClass('active');
    getTree({
        carStatus: carStatus,
        efStatus: efStatus,
        actionStatus:actionStatus
    });
    autoRefreshCarTree(true);
}

/**
 * 自动刷新车辆类表
 * @param {Boolean} refresh 是否自动刷新
 */
function autoRefreshCarTree(refresh) {
    treeTimer && clearTimeout(treeTimer);
    if (refresh) {
        treeTimer = setTimeout(function(){
            $('#side').find('.tools .active').trigger('click');
        }, 30 * 1000);
    }
}

$(function() {
    getCarTree(0,0,0,0);

    // 鼠标在车辆列表上时关闭自动刷新
    $('#side').on('mouseenter', function() {
        autoRefreshCarTree();
    }).on('mouseleave', function() {
        autoRefreshCarTree(true);
    })
})

// 搜索车牌号
function searchCar(el) {
    var carNumber = el.value,
        zTree, treeNode, model = [];

    if (carNumber != '') {
        zTree = $.fn.zTree.getZTreeObj('carTree');
        treeNode = zTree.getNodesByParamFuzzy('name', carNumber);
        $.each(treeNode, function(i, item) {
            model.push('<span onclick="selectCar(' + item.id + ')">' + item.name + '</span>');
        })
    }
    $('#autoSearch').html(model.join('')).show();
}

// 搜索定位
function selectCar(carId) {
    var zTree = $.fn.zTree.getZTreeObj('carTree');
    var node = zTree.getNodeByParam('id', carId);
    zTree.cancelSelectedNode(false);
    zTree.selectNode(node, true);
}
</script>

<div class="side" id="side2">
	<div class="tit">轨迹筛找（鄂A10001）</div>
	<div class="form">
		<div class="queryTime">
			<div class="item req">
				<label>开始时间：</label>
				<input type="text" name="startTime" id="queryStartTime" class="ipt" />
			</div>
			<div class="item req">
				<label>结束时间：</label>
				<input type="text" name="endTime" id="queryEndTime" class="ipt" />
			</div>
		</div>
		<div class="item">
			<label class="for"><i class="cbx" data-value="rail"></i>电子围栏</label>
			<label class="for"><i class="cbx" data-value="sos"></i>sos报警</label>
			<label class="for"><i class="cbx" data-value="status"></i>车辆处理警情</label>
		</div>
		<div class="button tc">
			<input type="hidden" class="ipt" name="carId" id="carId1" value="">
			<button type="button" class="ubtn ubtn-primary" id="jsubmit">查询</button>
		</div>
	</div>

	<div class="set">
		<p>播放倍速</p>
		<div class="speed">
			<label><input type="radio" name="speed" value="0.5" />x0.5</label>
			<label><input type="radio" name="speed" value="1" checked />x1</label>
			<label><input type="radio" name="speed" value="2" />x2</label>
			<label><input type="radio" name="speed" value="4" />x4</label>
			<label><input type="radio" name="speed" value="8" />x8</label>
		</div>
		<div class="ctrl">
			<button class="ico ico-play" id="jplay" onclick="_play(this)"></button>
			<span class="bar"><i class="time"></i><i class="dot"></i></span>
			<button class="ico ico-stop" onclick="_stop()"></button>
		</div>
	</div>

	<div class="open"></div>
</div>

<div class="footer-fix">
    <span>湖北省宏锐慧通信息技术有限公司</span>
</div>

<!-- 公用 -->
<script src="assets/plugins/layer/layer.js"></script>
<script src="assets/plugins/date/daterangepicker.min.js"></script>
<script src="assets/plugins/zTreeStyle/jquery.ztree.min.js"></script>
<script src="assets/js/common.js"></script>
<script src="http://webapi.amap.com/maps?v=1.3&key=9d870244cd940650899a73c0566d7652"></script>

<script src="assets/app/trackHis.js"></script>
</body>
</html>