<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>车管所智能管控平台</title>
    <meta name="renderer" content="webkit" />
    <link rel="shortcut icon" href="assets/images/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="stylesheet" href="assets/plugins/select2/select2.css" />
</head>
<body>

<!-- header begin -->
<div class="header cf">
	<div class="logo">
		<a href="index.html">车管所智能管控平台</a>
	</div>
	<div class="user">
        <span>当前在线人数：<em>15</em></span>
        <i>|</i>
        <span>历史登录人数：<em>430</em></span>
        <i>|</i>
        <span>admin</span>
        <i>|</i>
        <a href="login.html" class="logout"></a>
    </div>
</div>
<!-- header end -->

<div class="side-menu">
    <!-- menu.html -->
</div>

<div class="content">
    <div class="box">
        <div class="box-tit">
            <span class="t1">权限管理</span>
        </div>

        <div class="filter">
            <span class="ubtn ubtn-primary fr" onclick="searchNode()">查询</span>
            <input type="text" name="name" id="search" class="ipt fr" autocomplete="off" />

            <span class="ubtn ubtn-primary" onclick="_add()">新增</span>
            <span class="ubtn ubtn-primary" onclick="_edit()">修改</span>
            <span class="ubtn ubtn-cyan" onclick="_expandAll()">全部展开</span>
            <span class="ubtn ubtn-cyan" onclick="_collapseAll()">全部合并</span>
        </div>

        <div>
            <ul id="roleTree" class="ztree"></ul>
        </div>
    </div>
</div>

<div class="footer">
	<span>湖北省宏锐慧通信息技术有限公司</span>
</div>


<!-- 新增&编辑 -->
<div class="form layer-form" id="tempForm">
    <div class="ftit">添加</div>
    <form name="form1" id="form1" onsubmit="return false;">
        <div class="row">
            <label class="for">资源名称</label>
            <input type="text" class="ipt" name="resourceName" autocomplete="off" />
        </div>
        <div class="row">
            <label class="for">请求地址</label>
            <input type="text" class="ipt" name="resourceString" autocomplete="off" />
        </div>
        <div class="row">
            <label class="for">排序</label>
            <input type="text" class="ipt" name="priority" autocomplete="off" />
        </div>
        <div class="row">
            <label class="for">资源类型</label>
            <select name="resourceType" class="slt">
                <option value="url">菜单</option>
                <option value="button">按钮</option>
            </select>
        </div>
        <div class="row">
            <label class="for">是否启用</label>
            <select name="resourceEnable" id="" class="slt">
                <option value="0">启用</option>
                <option value="1">禁用</option>
            </select>
        </div>
        <div class="buttons">
            <input name="supResourceId" type="hidden" />
            <input name="resourceId" id="resourceId" type="hidden" />
            <button type="submit" class="ubtn ubtn-primary submit">确定</button>
            <button type="button" class="ubtn ubtn-gray layer-close">取消</button>
        </div>
    </form>
</div>
<!-- end 新增&编辑 -->

<!-- 公用 -->
<script src="assets/js/jquery191.js"></script>
<script src="assets/plugins/layer/layer.js"></script>
<script src="assets/js/common.js"></script>
<link rel="stylesheet" href="assets/plugins/zTreeStyle/jquery.ztree.css" />
<script src="assets/plugins/zTreeStyle/jquery.ztree.min.js"></script>
<script src="assets/plugins/validator/jquery.validator.min.js"></script>

<script>
    $.ajax({
        url: 'menu.html',
        cache: false,
        async: false,
        success: function(res) {
            $('.side-menu').html(res)
        }
    })
</script>

<script>
// 设置高亮字体
function setHighlight(treeId, treeNode) {
    return (treeNode.highlight) ? {'color':'#f8503f'} : {'color':'#333'};
}
var setting = {
    data: {
        simpleData: {
            enable: true,
            idKey: "id",
            pIdKey: "pId",
            rootPId: null
        }
    },
    view: {
        showLine: false,
        fontCss: setHighlight
    }
};

var pageSetting = {
    name      : "权限",   // 页面名称，用于提示信息
    getURL    : '',  // 编辑信息时回填表单
    delURL    : ''      // 删除一条数据
}

var treeData = [{"id":1,"pId":0,"name":"地图管控"},{"id":2,"pId":1,"name":"车辆监控"},{"id":3,"pId":1,"name":"调度管理"},{"id":4,"pId":1,"name":"历史轨迹"},{"id":5,"pId":1,"name":"电子围栏"},{"id":6,"pId":0,"name":"视频监控"},{"id":7,"pId":6,"name":"多车视频监控"},{"id":8,"pId":0,"name":"统计报表"},{"id":9,"pId":8,"name":"警情记录"},{"id":10,"pId":8,"name":"报警记录"},{"id":11,"pId":0,"name":"系统管理"},{"id":12,"pId":11,"name":"车辆管理"},{"id":13,"pId":11,"name":"机构管理"},{"id":14,"pId":11,"name":"用户管理"},{"id":15,"pId":11,"name":"角色管理"},{"id":16,"pId":11,"name":"权限管理"},{"id":17,"pId":0,"name":"修改密码"},{"id":18,"pId":0,"name":"注销"},{"id":19,"pId":0,"name":"主题"}];

var treeObj = $.fn.zTree.init($('#roleTree'), setting, treeData);
treeObj.expandAll(true);

// 全部展开
function _expandAll() {
    treeObj.expandAll(true);
}

// 全部折叠
function _collapseAll() {
    treeObj.expandAll(false);
}

function getSelectedNodes() {
    var selectedNodes = treeObj.getSelectedNodes();
    if (selectedNodes.length > 0) {
        return selectedNodes[0].id;
    }
    return '';
}
var nodeList = [];

function updateNodes(highlight) {
    var i = 0,
        len = nodeList.length;
    for (; i < len; i++) {
        nodeList[i].highlight = highlight;
        treeObj.updateNode(nodeList[i]);
        treeObj.selectNode(nodeList[i]);
    }
    treeObj.cancelSelectedNode();
}

// 搜索
function searchNode() {
    var val = $('#search').val().replace(/^\s+|\s+$/g, '');
    updateNodes(false);
    if (val) {
        nodeList = treeObj.getNodesByParamFuzzy('name', val);
        updateNodes(true);
    }
}

// 新增
function _add() {
    var $temp = $('#tempForm');
    var $form = $temp.find('form');
    $form[0].reset();
    $form.prev('.title').html('新增' + pageSetting.name);
    layer.open({
        area: '560px',
        type: 1,
        title: false,
        content: $temp
    })
}

// 编辑
function _edit() {
    var id = getSelectedNodes();
    if (id === '') {
        $.notify({'title': '请选择一个节点!', type: 'warning'});
    } else {
        var $temp = $('#tempForm');
        var $form = $temp.find('form');
        $form[0].reset();
        $form.prev('.title').html(pageSetting.name + '信息编辑');
        $.ajax({
            url: pageSetting.getURL,
            data: {id: id},
            success: function(res) {
                res = {data:{}}
                $form.find('.ipt, .slt').each(function(i, item) {
                    this.value = res.data[this.name] || '';
                })
                layer.open({
                    area: '560px',
                    type: 1,
                    title: false,
                    content: $temp
                })
            }
        })
    }
}

// 删除一行
function _del(id) {
    var id = getSelectedNodes();
    if (id === '') {
        $.notify({'title': '请选择一个节点!', type: 'warning'});
    } else {
        layer.confirm('确定要删除该' + pageSetting.name + '么？', function(k) {
            $.ajax({
                url: pageSetting.delURL,
                data: {id: id},
                success: function(res) {
                    if (res.result === "SUCCESS") {
                        $.notify({
                            title: "删除成功",
                            type: "success"
                        })
                    }
                }
            })
            layer.close(k);
        })
    }
}


$(function() {
    // 提交表单
    $('#form1').validator({
        fields: {
            resourceName: 'required',
            resourceString: 'required'
        },
        valid: function() {
            var id = getSelectedNodes();
            var data = {}
            $('#resourceId').val(id);
            $.each($form.serializeArray(), function(i, item) {
                data[item.name] = item.value;
            })
            $.ajax({
                url: pageSetting.submitURL,
                data: data,
                success: function() {}
            })
        }
    });
})
</script>
</body>
</html>