<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>新增警情</title>
    <meta name="renderer" content="webkit" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="stylesheet" href="assets/plugins/select2/select2.css" />
    <style>
    body{background:#fff;}
    .layer-form{display:block;}
    .amap{width:100%;height:100px;border:1px solid #ddd;border-radius:3px;}
    </style>
</head>

<body>

<form id="myform" name="addAlarm" method="POST" action="javascript:return false;">
    <div class="form layer-form">
        <div class="ftit">新增警情</div>
        <div class="item req">
            <div class="txt">警情立案时间：</div>
            <div class="cnt">
                <input class="ipt" name="time" type="text">
            </div>
        </div>
        <div class="item req">
            <div class="txt">警情类别：</div>
            <div class="cnt">
                <select name="type" class="slt select2">
                    <option value="">火灾</option>
                </select>
            </div>
        </div>
        <div class="item req">
            <div class="txt">警情燃烧对象：</div>
            <div class="cnt">
                <select name="obj" class="slt select2">
                    <option value="">居民住宅</option>
                </select>
            </div>
        </div>
        <div class="item req">
            <div class="txt">警情级别：</div>
            <div class="cnt">
                <select name="obj" class="slt select2">
                    <option value="">一级警情</option>
                </select>
            </div>
        </div>
        <div class="item req">
            <div class="txt">警情案发地点：</div>
            <div class="cnt">
                <input type="text" class="ipt" name="address" id="tipinput2" autocomplete="off">
                <input type="hidden" name="lng" id="lng">
                <input type="hidden" name="lat" id="lat">
            </div>
        </div>
        <div class="item">
            <div class="txt">地图选点：</div>
            <div class="cnt">
                <div class="amap" id="amap"></div>
                <div class="fr">
                    警情GPS纬度：<i id="slng"></i>
                </div>
                <div class="fl">
                    警情GPS经度：<i id="slat"></i>
                </div>
            </div>
        </div>
        <div class="item req">
            <div class="txt">警情处置机构：</div>
            <div class="cnt">
                <select name="org" class="slt select2">
                    <option value="">江岸大队</option>
                </select>
            </div>
        </div>
        <div class="item req">
            <div class="txt">报警人姓名：</div>
            <div class="cnt">
                <input class="ipt" name="username" type="text">
            </div>
        </div>
        <div class="item req">
            <div class="txt">报警人电话：</div>
            <div class="cnt">
                <input class="ipt" name="mobile" type="text">
            </div>
        </div>
        <div class="item">
            <div class="txt">报警内容：</div>
            <div class="cnt">
                <input class="ipt" name="content" type="text">
            </div>
        </div>
        <div class="buttons">
            <button type="reset" class="ubtn ubtn-gray">取消</button>
            <button type="submit" class="ubtn ubtn-red">确定</button>
        </div>
    </div>
</form>


<script src="assets/js/jquery191.js"></script>
<script src="assets/plugins/layer/layer.js"></script>
<script src="assets/plugins/select2/select2.js"></script>
<script src="http://webapi.amap.com/maps?v=1.3&key=9d870244cd940650899a73c0566d7652&plugin=AMap.Autocomplete,AMap.PlaceSearch,AMap.Geocoder"></script>
<script>

$('.select2').select2({
    minimumResultsForSearch: -1
})
var map = new AMap.Map('amap');
var marker = null;

//输入提示
var autoOptions = {
    input: "tipinput2"
};
var auto = new AMap.Autocomplete(autoOptions);
var placeSearch = new AMap.PlaceSearch({
    map: map
});  //构造地点查询类
AMap.event.addListener(auto, 'select', _autoSelect);//注册监听，当选中某条记录时会触发
AMap.event.addListener(placeSearch, 'markerClick', _markerClick);//注册监听，当点击某个点时会触发
function _autoSelect(e) {
    if (e.poi && e.poi.location) {
        map.setZoom(15);
        map.setCenter(e.poi.location);
        $('#lng').val(e.poi.location.lng);
        $('#lat').val(e.poi.location.lat);
        $('#slng').html(e.poi.location.lng);
        $('#slat').html(e.poi.location.lat);
    }
    placeSearch.setCity(e.poi.adcode);
    placeSearch.search(e.poi.name);  //关键字查询查询
}

function _markerClick(e) {
    if (e.data && e.data.location) {
        map.setZoom(15);
        map.setCenter(e.data.location);
        var pt = {
            lng: e.data.location.lng,
            lat: e.data.location.lat
        }
        var address = e.data.name;
        mapCallback(pt, address);
    }
}

map.on('click', function(e) {
    var address = '';
    var pt = {
        lng: e.lnglat.getLng(),
        lat: e.lnglat.getLat()
    }
    var geocoder = new AMap.Geocoder({
        radius: 1000,
        extensions: "all"
    });
    var lnglatXY = new AMap.LngLat(pt.lng, pt.lat); 
    geocoder.getAddress(lnglatXY, function(status, result) {
        if (status === 'complete' && result.info === 'OK') {
            address = result.regeocode.formattedAddress;
        }
        try{
            mapCallback(pt, address);
        }catch(err){}
    });
});

// 地图选点回调
function mapCallback(pt, address) {
    var msg = '确定保存该地点经纬度？ <br/>';
    msg += '地点位置：' + address + '<br/>';
    msg += '地点坐标：经度：' + pt.lng + ',纬度：' + pt.lat + '<br/>';

    layer.confirm(msg, function() {
        $('#tipinput2').val(address);
        $('#lng').val(pt.lng);
        $('#lat').val(pt.lat);
        $('#slng').html(pt.lng);
        $('#slat').html(pt.lat);
        layer.closeAll();

        try {
            marker && marker.setMap(null);
        }catch(err) {}

        // 定义图标
        marker = new AMap.Marker({
            map: map,
            position: [pt.lng, pt.lat],
            icon: new AMap.Icon({            
                size: new AMap.Size(23, 28), 
                image: 'assets/images/icon/marker.png'
            })        
        });
    });
}

</script>
</body>
</html>