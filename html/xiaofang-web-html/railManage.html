<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>电子围栏</title>
    <meta name="renderer" content="webkit" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="stylesheet" href="assets/plugins/select2/select2.css" />
	<script src="assets/js/jquery191.js"></script>
</head>
<body>
<div class="side" id="side">
    <div class="search">
        <form name="search">
            <label>车辆列表</label>
            <input type="text" class="ipt" placeholder="请输车牌号" onkeyup="searchCar(this)">
            <button type="button" class="ico ico-search"></button>
            <button type="button" onclick="getCarTree(0,0,0,0)" class="ico ico-refresh"></button>
        </form>
        <div class="choose" id="autoSearch"></div>
    </div>
    <div class="tools">
        <span class="li active" onclick="getCarTree(0,0,0, 0)"><i class="ico ico-1"></i>全部车辆</span>
        <span class="li" onclick="getCarTree(2,0,0, 1)"><i class="ico ico-2"></i>在线车辆</span>
        <span class="li" onclick="getCarTree(1,0,0, 2)"><i class="ico ico-3"></i>离线车辆</span>
        <span class="li" onclick="getCarTree(0,0,1, 3)"><i class="ico ico-4"></i>出警车辆</span>
    </div>
    <div class="open"></div>
    <ul id="carTree" class="ztree"></ul>
</div>

<script>
var cars = {};
var treeTimer;

// 保存勾选状态使刷新时不会被重置
var nodeChecked = {};
function nodeCollapse(event, treeId, treeNode) {
    nodeChecked[treeNode.id] = false;
}
function nodeExpand(event, treeId, treeNode) {
    nodeChecked[treeNode.id] = true;
}

/**
 * 自动刷新车辆列表
 * @param {Boolean} refresh 是否自动刷新
 */
function autoRefreshCarTree(refresh) {
    treeTimer && clearTimeout(treeTimer);
    if (refresh) {
        treeTimer = setTimeout(function(){
            var str = $('#side').find('.tools .active').attr('onclick');
            // eval(str)
        }, 50 * 1000);
    }
}

// 获取小车树形菜单
function getTree(data) {
    if (typeof window.setting === 'undefined') {
        return;
    }
    $.ajax({
        url: '/carMonitor/getTree',
        url: 'json/carTree.json',
        dataType: 'json',
        data: data,
        cache: false,
        success: function(res) {
            var treeObj,nodes;
            $.fn.zTree.destroy('carTree');
            treeObj = $.fn.zTree.init($('#carTree'), setting, res);
            nodes = treeObj.transformTozTreeNodes(res);
            var loop = function(nodes, level) {
                $.each(nodes, function(i, node) {
                    if (nodeChecked[node.id]) {
                        node.open = true;
                    }
                    if (cars[node.id]) {
                        node.checked = true;
                    }
                    if (node.iconSkin === 'car') {
                        try {
                            node.icon = carIconObj[node.carType]['s' + node.carState];
                            cars[node.id].setIcon(carIconObj[node.carType]['b' + node.carState]);
                        } catch (err) {}
                    } else {
                        node.iconSkin = 'org org' + level + ' ';
                        // node.icon = 'assets/images/icon/level' + level + '.png';
                    }
                    if (node.children) {
                        loop(node.children, level+1);
                    }
                })
            }
            loop(nodes, 1);

            treeObj = $.fn.zTree.init($('#carTree'), setting, nodes);

            if (typeof setting.done === 'function') {
                setting.done(treeObj);
                setting.done = null;
            }
        },
        error: function() {
            $.notify({
                type: 'danger',
                title: '数据加载失败!'
            })
        }
    })
}

// 获取小车树形菜单
function getCarTree(carStatus, efStatus,actionStatus,idx) {
    // 导航高亮
    $('#side').find('.tools .li').eq(idx).addClass('active').siblings().removeClass('active');

    getTree({
        carStatus: carStatus,
        efStatus: efStatus,
        actionStatus:actionStatus
    });

    autoRefreshCarTree(true);
}

function niceResize() {
    $('#carTree').getNiceScroll().resize();
}

$(function() {
    getCarTree(0,0,0,0);

    // 鼠标在车辆列表上时关闭自动刷新
    $('#side').on('mouseenter', function() {
        autoRefreshCarTree(false);
    }).on('mouseleave', function() {
        autoRefreshCarTree(true);
    })

    // var nice = $('#carTree').niceScroll({
    //     cursorcolor: '#333',
    //     cursorwidth: '5px',
    //     cursorborder: 0,
    //     scrollspeed: 60,
    //     mousescrollstep: 40,
    //     autohidemode: 'leave',
    //     background: '#ccc',
    //     cursorborderradius: '5px'
    // })
})

// 搜索车牌号
function searchCar(el) {
    var carNumber = el.value,
        zTree, treeNode, model = [];

    if (carNumber != '') {
        zTree = $.fn.zTree.getZTreeObj('carTree');
        treeNode = zTree.getNodesByParamFuzzy('name', carNumber);
        $.each(treeNode, function(i, item) {
            model.push('<span onclick="selectCar(' + item.id + ')">' + item.name + '</span>');
        })
    }
    $('#autoSearch').html(model.join('')).show();
}

// 搜索定位
function selectCar(carId) {
    var zTree = $.fn.zTree.getZTreeObj('carTree');
    var node = zTree.getNodeByParam('id', carId);
    zTree.cancelSelectedNode(false);
    zTree.selectNode(node, true);
}
</script>

<script src="assets/app/carTree.js"></script>

<div class="map" id="map"></div>

<div class="side" id="side3">
	<div class="inner">
	<div class="tit">围栏列表</div>
	<div class="nice-table">
		<div class="thead">
			<em class="col2">围栏名称</em>
			<em class="col3">状态</em>
			<em class="col3">车辆数</em>
		</div>
		<div class="tbody">
			<div class="tr">
				<em class="col2" data-id="1"><i class="cbx"></i>泛海中队辖区</em>
				<em class="col3">生效</em>
				<em class="col3">3</em>
			</div>
			<div class="tr">
				<em class="col2" data-id="1"><i class="cbx"></i>洪山中队辖区</em>
				<em class="col3">生效</em>
				<em class="col3">3</em>
			</div>
			<div class="tr">
				<em class="col2" data-id="1"><i class="cbx"></i>硚口中队辖区</em>
				<em class="col3">生效</em>
				<em class="col3">3</em>
			</div>
			<div class="tr">
				<em class="col2" data-id="1"><i class="cbx"></i>洪山中队辖区</em>
				<em class="col3">生效</em>
				<em class="col3">3</em>
			</div>
			<div class="tr">
				<em class="col2" data-id="1"><i class="cbx"></i>硚口中队辖区</em>
				<em class="col3">生效</em>
				<em class="col3">3</em>
			</div>
		</div>
	</div>
	<div class="buttons">
		<button type="button" class="ubtn ubtn-primary" id="jcreate">创建</button>
		<button type="button" class="ubtn ubtn-red" id="jdel">删除</button>
		<button type="button" class="ubtn ubtn-red" id="jrefresh">刷新</button>
	</div>

	<div class="form">
		<form name="createRail" id="createRail">
			<div class="item req">
				<label>围栏名称：</label>
				<input name="name" class="ipt" type="text">
			</div>
			<div class="item req">
				<label>围栏报警类型：</label>
				<select name="type" class="slt select2">
					<option value="1">平台报警</option>
					<option value="2">车机报警</option>
					<option value="3">平台+车机报警</option>
				</select>
			</div>
			<div class="item req" style="margin-bottom:4px;">
				<label>围栏状态：</label>
				<span class="tn">
					<label style="margin-right:16px;"><input class="_cbx" type="radio" name="enabled" value="1" checked="" />生效</label>
					<label><input class="_cbx" type="radio" name="enabled" value="0" />未生效</label>
				</span>
			</div>
			<div class="item">
				<label class="for"><input class="_cbx" type="checkbox" name="enter">进围栏报警</label>
				<label class="for"><input class="_cbx" type="checkbox" name="leave">出围栏报警</label>
				<label class="for"><input class="_cbx" type="checkbox" name="time">开启有效时间</label>
			</div>
			<div class="queryTime">
			<div class="item">
				<label>开始时间：</label>
				<input name="startTime" id="queryStartTime" class="ipt" type="text">
			</div>
			<div class="item">
				<label>结束时间：</label>
				<input name="endTime" id="queryEndTime" class="ipt" type="text">
			</div>
			</div>

			<div class="btm">
				<button type="button" class="ubtn ubtn-red fr" id="jsubmit" onclick="_saveRail()">保存</button>
				<button type="button" class="ubtn ubtn-primary" id="jreset" onclick="_removeMarker()">重新画图</button>
			</div>

			<div class="car">
				<p>绑定车辆列表：</p>
			</div>

		</form>
	</div>
	</div>
    <div class="open"></div>
</div>

<div class="footer-fix">
    <span>湖北省宏锐慧通信息技术有限公司</span>
</div>

<!-- 公用 -->
<script src="assets/plugins/layer/layer.js"></script>
<script src="assets/js/common.js"></script>

<!-- 页面专用 -->
<link rel="stylesheet" href="assets/css/drawingManager.css" />
<link rel="stylesheet" href="assets/plugins/date/daterangepicker.min.css" />
<script src="assets/plugins/date/daterangepicker.min.js"></script>
<script src="assets/plugins/zTreeStyle/jquery.ztree.min.js"></script>
<script src="http://webapi.amap.com/maps?v=1.3&key=9d870244cd940650899a73c0566d7652&plugin=AMap.MouseTool,AMap.PolyEditor,AMap.CircleEditor"></script>
<script src="assets/js/drawingManager.js"></script>

<script>
// 勾选小车
function checkCar(event, treeId, treeNode) {
	var id = treeNode.id;
	if (treeNode.checked) {
		$('.car').append('<label id="car' + id + '">' + treeNode.name + '</label>');
	} else {
		$('#car' + id).remove();
	}
}


// 点击机构或小车名称
function clickCarName(event, treeId, treeNode) {
    var checked = treeNode.checked;
    clickCarInput(event, treeId, treeNode, checked);
}

// 勾选机构或小车
function clickCarInput(event, treeId, treeNode, checked) {
    var zTree = $.fn.zTree.getZTreeObj('carTree'),
        nodes = zTree.getCheckedNodes(true),
        value = [];
    cars = {}; // 重置车辆勾选状态
    if (typeof checked !== 'undefined') {
    	zTree.checkNode(treeNode, !checked, true);
    	zTree.cancelSelectedNode(); // 取消节点选中状态
    }
    $.each(nodes, function(i, item) {
        // 保存机构和车辆勾选状态
        cars[item.id] = true;
        if (item.iconSkin === 'car') {
            value.push(nodes[i].name);
        }
    })
    $('.car').html('<p>绑定车辆列表：</p><label>' + value.join('</label><label>') + '</label>');
}

/**
 * 只显示子节点图标
 * @return {null}
 */
function showIconBySon(treeId, treeNode) {
    return treeNode.iconSkin;
}

var setting = {
    check: {
        enable: true,
        chkboxType: { 
            'Y': 'ps',
            'N': 'ps'
        }
    },
    data: {
        simpleData: {
            enable: true,
            idKey: "id",
            pIdKey: "pid",
            rootPId: null
        }
    },
    view: {
        dblClickExpand: false,
        showIcon: showIconBySon
    },
    callback: {
        onClick: clickCarName,
        onCheck: clickCarInput
    }
};


var map = new AMap.Map('map',{zoom:14});

// 鼠标工具，绘制圆形、矩形、多边形
var drawingManager = new DrawingManager(map, {
    drawingModes: [
        'circle',
        // 'rectangle',
        'polygon',
        'polyline'
    ]
});

var _global = {
	init: function() {
		this.bindEvent();
	},
	bindEvent: function() {
		var $form = $('#createRail');
		$('.nice-table').on('click', '.cbx', function() {
			$(this).toggleClass('cbx-on');
			return false;
		})

		// 编辑围栏
		$('.nice-table').on('click', '.col2', function() {
			var id = $(this).data('id');
			$.ajax({
				url: '',
				data: {id: id},
				success: function(res) {
					res = {
						name: '泛海中队辖区',
						enabled: 1,
		        		type: 1,
		        		start: '17:33:04',
		        		end: '17:33:04',
						cars: ['鄂A10020'],
						enter: 1,
						leave: 1,
						time: 1,
						cars: [4, 6],
						drawType: 'circle',
						path: [],
						center: [114.279475, 30.589158],
						radius: 1000
					}
					_initFormByPara(res);
				}
			})
		})
	
		// 删除
		$('#jdel').on('click', function() {
			var ids = [];
			$('.nice-table').find('.cbx-on').each(function(i) {
				ids.push($(this).parent().data('id'));
			})
			if (ids.length === 0) {
				$.notify({
					'title': '请先勾选要删除的围栏',
					'type': 'warning'
				})
			} else {
				layer.confirm('确认删除吗？', function(idx) {
					$.ajax({
						url: '',
						data: {id: ids.join(',')},
						success: function(res) {
							$('.nice-table').find('.cbx-on').each(function() {
								$(this).closest('.tr').remove();
								layer.close(idx);
							})
						}
					})
				})
			}
		})

		// 创建围栏
		$('#jcreate').on('click', function() {
			$form[0].reset();
			$form.parent().toggle();
			$('.car').html('<p>绑定车辆列表：</p>');
		})

		$('.queryTime').date({
            time1: '#queryStartTime',
            time2: '#queryEndTime',
            format: 'YYYY/MM/DD HH:mm'
        })
	}
}

</script>

</body>
</html>