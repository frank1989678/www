<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>历史轨迹</title>
    <meta name="renderer" content="webkit" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <script src="assets/js/jquery191.js"></script>
</head>
<body>
<div class="side" id="side">
    <div class="search">
        <form name="search">
            <label>车辆列表</label>
            <input type="text" class="ipt" placeholder="请输车牌号" onkeyup="searchCar(this)">
            <button type="button" class="ico ico-search"></button>
            <button type="button" onclick="getCarTree(0,0,0,0)" class="ico ico-refresh"></button>
        </form>
        <div class="choose" id="autoSearch"></div>
    </div>
    <div class="tools">
        <span class="li active" onclick="getCarTree(0,0,0, 0)"><i class="ico ico-1"></i>全部车辆</span>
        <span class="li" onclick="getCarTree(2,0,0, 1)"><i class="ico ico-2"></i>在线车辆</span>
        <span class="li" onclick="getCarTree(1,0,0, 2)"><i class="ico ico-3"></i>离线车辆</span>
        <span class="li" onclick="getCarTree(0,0,1, 3)"><i class="ico ico-4"></i>出警车辆</span>
    </div>
    <div class="open"></div>
    <ul id="carTree" class="ztree"></ul>
</div>

<script>
var cars = {};
var treeTimer;

// 保存勾选状态使刷新时不会被重置
var nodeChecked = {};
function nodeCollapse(event, treeId, treeNode) {
    nodeChecked[treeNode.id] = false;
}
function nodeExpand(event, treeId, treeNode) {
    nodeChecked[treeNode.id] = true;
}

/**
 * 自动刷新车辆列表
 * @param {Boolean} refresh 是否自动刷新
 */
function autoRefreshCarTree(refresh) {
    treeTimer && clearTimeout(treeTimer);
    if (refresh) {
        treeTimer = setTimeout(function(){
            var str = $('#side').find('.tools .active').attr('onclick');
            // eval(str)
        }, 50 * 1000);
    }
}

// 获取小车树形菜单
function getTree(data) {
    if (typeof window.setting === 'undefined') {
        return;
    }
    $.ajax({
        url: '/carMonitor/getTree',
        url: 'json/carTree.json',
        dataType: 'json',
        data: data,
        cache: false,
        success: function(res) {
            var treeObj,nodes;
            $.fn.zTree.destroy('carTree');
            treeObj = $.fn.zTree.init($('#carTree'), setting, res);
            nodes = treeObj.transformTozTreeNodes(res);
            var loop = function(nodes, level) {
                $.each(nodes, function(i, node) {
                    if (nodeChecked[node.id]) {
                        node.open = true;
                    }
                    if (cars[node.id]) {
                        node.checked = true;
                    }
                    if (node.iconSkin === 'car') {
                        try {
                            node.icon = carIconObj[node.carType]['s' + node.carState];
                            cars[node.id].setIcon(carIconObj[node.carType]['b' + node.carState]);
                        } catch (err) {}
                    } else {
                        node.iconSkin = 'org org' + level + ' ';
                        // node.icon = 'assets/images/icon/level' + level + '.png';
                    }
                    if (node.children) {
                        loop(node.children, level+1);
                    }
                })
            }
            loop(nodes, 1);

            treeObj = $.fn.zTree.init($('#carTree'), setting, nodes);

            if (typeof setting.done === 'function') {
                setting.done(treeObj);
                setting.done = null;
            }
        },
        error: function() {
            $.notify({
                type: 'danger',
                title: '数据加载失败!'
            })
        }
    })
}

// 获取小车树形菜单
function getCarTree(carStatus, efStatus,actionStatus,idx) {
    // 导航高亮
    $('#side').find('.tools .li').eq(idx).addClass('active').siblings().removeClass('active');

    getTree({
        carStatus: carStatus,
        efStatus: efStatus,
        actionStatus:actionStatus
    });

    autoRefreshCarTree(true);
}

function niceResize() {
    $('#carTree').getNiceScroll().resize();
}

$(function() {
    getCarTree(0,0,0,0);

    // 鼠标在车辆列表上时关闭自动刷新
    $('#side').on('mouseenter', function() {
        autoRefreshCarTree(false);
    }).on('mouseleave', function() {
        autoRefreshCarTree(true);
    })

    // var nice = $('#carTree').niceScroll({
    //     cursorcolor: '#333',
    //     cursorwidth: '5px',
    //     cursorborder: 0,
    //     scrollspeed: 60,
    //     mousescrollstep: 40,
    //     autohidemode: 'leave',
    //     background: '#ccc',
    //     cursorborderradius: '5px'
    // })
})

// 搜索车牌号
function searchCar(el) {
    var carNumber = el.value,
        zTree, treeNode, model = [];

    if (carNumber != '') {
        zTree = $.fn.zTree.getZTreeObj('carTree');
        treeNode = zTree.getNodesByParamFuzzy('name', carNumber);
        $.each(treeNode, function(i, item) {
            model.push('<span onclick="selectCar(' + item.id + ')">' + item.name + '</span>');
        })
    }
    $('#autoSearch').html(model.join('')).show();
}

// 搜索定位
function selectCar(carId) {
    var zTree = $.fn.zTree.getZTreeObj('carTree');
    var node = zTree.getNodeByParam('id', carId);
    zTree.cancelSelectedNode(false);
    zTree.selectNode(node, true);
}
</script>

<script src="assets/app/carTree.js"></script>

<div class="map" id="map"></div>

<div class="side" id="side2">
	<div class="tit" id="carCode1">轨迹筛找（鄂A10001）</div>
	<div class="form">
        <div class="queryTime">
    		<div class="item req">
    			<label>开始时间：</label>
    			<input type="text" name="startTime" id="queryStartTime" class="ipt" />
    		</div>
    		<div class="item req">
    			<label>结束时间：</label>
    			<input type="text" name="endTime" id="queryEndTime" class="ipt" />
    		</div>
        </div>
		<div class="item">
			<label class="for"><i class="cbx" data-value="rail"></i>电子围栏</label>
			<label class="for"><i class="cbx" data-value="sos"></i>sos报警</label>
			<label class="for"><i class="cbx" data-value="status"></i>车辆处理警情</label>
		</div>
		<div class="button tc">
            <input type="hidden" class="ipt" name="carId" id="carId1" value="0">
			<button type="button" class="ubtn ubtn-red" id="jsubmit">查询</button>
		</div>
	</div>

	<div class="set">
		<p>播放倍速</p>
		<div class="speed">
			<label><input type="radio" name="speed" value="0.5" />x0.5</label>
			<label><input type="radio" name="speed" value="1" checked />x1</label>
			<label><input type="radio" name="speed" value="2" />x2</label>
			<label><input type="radio" name="speed" value="4" />x4</label>
			<label><input type="radio" name="speed" value="8" />x8</label>
		</div>
		<div class="ctrl">
			<button class="ico ico-play" id="jplay" onclick="_play(this)"></button>
			<span class="bar"><i class="time"></i><i class="dot"></i></span>
			<button class="ico ico-stop" onclick="_stop()"></button>
		</div>
	</div>

	<div class="open"></div>
</div>

<div class="footer-fix">
    <span>湖北省宏锐慧通信息技术有限公司</span>
</div>

<!-- 公用 -->
<script src="assets/plugins/layer/layer.js"></script>
<script src="assets/js/common.js"></script>

<!-- 页面专用 -->
<script src="assets/plugins/zTreeStyle/jquery.ztree.min.js"></script>
<script src="assets/plugins/datepicker/WdatePicker.js"></script>
<script src="http://webapi.amap.com/maps?v=1.3&key=9d870244cd940650899a73c0566d7652"></script>

<script>
var CHECK_CAR = 0;

// 点击机构或小车名称
function clickCarName(event, treeId, treeNode) {
    var zTree = $.fn.zTree.getZTreeObj('carTree');
    var checked = treeNode.checked;

    if (treeNode.iconSkin === 'car') {
        zTree.checkNode(treeNode, !checked, false);
        clickCarInput(event, treeId, treeNode);
    }

    zTree.cancelSelectedNode(); // 取消节点选中状态
}
// 勾选小车
function clickCarInput(event, treeId, treeNode) {
    var name = '';
	var id = treeNode.id;
    if (treeNode.iconSkin !== 'car') {
        var treeObj = $.fn.zTree.getZTreeObj("carTree");
        treeObj.checkNode(treeNode, false, false);
        $.notify({
            title: '不能选择机构',
            type: 'warning'
        })
        return;
    }
    cars = {};
    if (treeNode.checked) {
        cars[id] = true;
		CHECK_CAR = id;
        name = '(' + treeNode.name + ')';
	} else {
		CHECK_CAR = 0;
	}
    $("#carCode1").html('轨迹筛找' + name);
    $("#carId1").val(CHECK_CAR);
}
/**
 * 只显示子节点图标
 * @return {null}
 */
function showIconBySon(treeId, treeNode) {
    return treeNode.iconSkin;
}

var setting = {
    check: {
        enable: true,
        chkStyle: 'radio',
        radioType: 'all'
    },
    data: {
        simpleData: {
            enable: true,
            idKey: "id",
            pIdKey: "pid",
            rootPId: null
        }
    },
    view: {
        dblClickExpand: false,
        showIcon: showIconBySon,
        showLine: true
    },
    callback: {
        onClick: clickCarName,
        onCheck: clickCarInput
    },
    // 执行一次
    done: function(treeObj) {
        var id = fx.GetQueryString('id');
        if (id) {
            var node = treeObj.getNodeByParam('id', id);
            treeObj.checkNode(node,true,false);
            cars[id] = true;
            CHECK_CAR = id;
            $("#carCode1").html('轨迹筛找（' + node.name + '）');
            $("#carId1").val(id);
        }
    }
};


var map = new AMap.Map('map');

var car,
	markers = [],
	status = 'stop',
	speed = 1000,
	lineArr = [];

function showCar(data) {

    lineArr = [];
    $.each(data.cprList,function (i,item) {
        lineArr.push([item.longitude,item.latitude]);
    })

	if (car) {
		car.stopMove();
		car.setMap(null);
		map.remove(markers);
		markers = [];
	}
	status = 'stop';
	$('#jplay').attr('class', 'ico ico-play');
	car = new AMap.Marker({
	    map: map,
	    position: lineArr[0],
	    icon: 'assets/images/icon/water/green.png',
	    offset: new AMap.Pixel(-20, -15),
	    autoRotation: true
	});

	// 绘制轨迹
	var polyline = new AMap.Polyline({
	    map: map,
	    path: lineArr,
	    strokeColor: "#afb8e5",  //线颜色
	    strokeWeight: 8      //线宽
	});
	markers.push(polyline);

	// SOS点
	$.each(data.SOS, function(i, item) {
		var pos = item.car.agency;
		if (pos.longitude == null || pos.latitude == null) {
			return true;
		}
        var SOS = new AMap.Marker({
            map: map,
            position: [pos.longitude, pos.latitude],
            offset: new AMap.Pixel(-22, -30),
            content: '<div class="tips-sos">SOS</div>'
        });
        markers.push(SOS);
	})

	// 警情点
	$.each(data.alarmSituation, function(i, item) {
		if (item.asLongitude == null || item.asLatitude == null) {
			return true;
		}
		var status = new AMap.Marker({
	        map: map,
	        position: [item.asLongitude, item.asLatitude],
	        offset: new AMap.Pixel(-15, -15),
	        content: '<div class="tips-status">' + (i+1) + '</div>'
	    });
	    markers.push(status);
	})

	// 电子围栏
	
    // var rail = new AMap.Polygon({
    //     path: data.rail,//设置多边形边界路径
    //     strokeColor: "#8fc31f", //线颜色
    //     strokeOpacity: 0.6, //线透明度
    //     strokeWeight: 3,    //线宽
    //     fillColor: "#8fc31f", //填充色
    //     fillOpacity: 0.2//填充透明度
    // });
    // rail.setMap(map);
    // markers.push(rail);

	map.setFitView();
}


function _play(el) {
	if (!car) {
		return;
	}
	switch (status) {
		case 'stop':
			if (lineArr.length > 0) {
				var k = $('.speed').find('input:checked').val();
				car.moveAlong(lineArr, speed * k);
				status = 'play';
				el.className = 'ico ico-purse';
			}
			break;
		case 'play':
			car.pauseMove();
			status = 'purse';
			el.className = 'ico ico-play';
			break;
		case 'purse':
			car.resumeMove();
			el.className = 'ico ico-purse';
			status = 'play';
			break;
	}
}
function _stop() {
	if (car) {
		status = 'stop';
		car.setPosition(lineArr[0]);
		car.stopMove();
	}
}


var _global = {
	init: function() {
        this.jeDate();
		this.filter();
	},
    jeDate: function() {
        $('#queryStartTime').on('click', function() {
            WdatePicker({
                autoPickDate: true,
                maxDate: '#F{$dp.$D(queryEndTime)}',
                dateFmt: 'yyyy/MM/dd HH:mm:ss'
            })
        })
        $('#queryEndTime').on('click', function() {
            WdatePicker({
                autoPickDate: true,
                minDate: '#F{$dp.$D(queryStartTime)}',
                maxDate: '#F{$dp.$D(queryStartTime,{d:2})}',
                dateFmt: 'yyyy/MM/dd HH:mm:ss'
            });
        })
    },
	filter: function() {
		var $form = $('.form');

        $form.on('click', '.for', function() {
        	$(this).find('.cbx').toggleClass('cbx-on');
        })

        $('#jsubmit').on('click', function() {
        	var time1 = $('#queryStartTime').val(),
        		time2 = $('#queryEndTime').val(),
        		seconds = (new Date(time2).getTime()) - (new Date(time1).getTime()),
        		day7 = 7 * 24 * 60 * 60 * 1e3,
        		minute = 30 * 60 * 1e3,
        		data = {};

        	if (CHECK_CAR === 0) {
        		$.notify({
					'title': '请先勾选小车',
					'type': 'warning'
				})	    
				return false;   
        	} else if(!time1 || !time2) {
                $.notify({
                    'title': '请选择时间',
                    'type': 'warning'
                })
                return false;
            } else if (seconds > day7) {
        		$.notify({
					'title': '开始时间与结束时间差≤7天',
					'type': 'warning'
				})	    
				return false;
        	} else if (seconds < minute) {
        		$.notify({
					'title': '开始时间与结束时间差≥30分钟',
					'type': 'warning'
				})	 
				return false;   
        	}
        	data = {
        		id: CHECK_CAR,
        		start: time1,
        		end: time2
        	}
        	$form.find('.cbx-on').each(function() {
        		data[$(this).data('value')] = true
        	})
        	$.ajax({
                url: 'json/a.json',
        		url: 'json/trackHis.json',
        		data: data,
        		success: function(res) {
        			showCar(res);
        		}
        	})
        })
	}
}

</script>

</body>
</html>