<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>新建报价-boss</title>
    <meta name="renderer" content="webkit" />
    <link rel="stylesheet" href="css/style.css" />
</head>

<body>

    <!-- header start -->
    <div class="header">
        <div class="wrap">
            <div class="logo">
                <a href="home.html">药优优电子商务管理系统</a>
            </div>
            <div class="user">
                <span>登录用户 hehuan</span>
                <i>|</i>
                <span>2016年6月20日 星期三</span>
                <i>|</i>
                <a href="logout.html">退出</a>
            </div>
        </div>
    </div><!-- header end -->


    <!-- nav start -->
    <div class="nav">
        <div class="wrap">
            <ul>
                <li><a href="home.html">首页</a></li>
                <li>
                    <a class="curr" href="#!">销售</a>
                    <div class="subnav">
                        <a class="on" href="enquiry.html">询价管理</a>
                        <a href="order.html">订单管理</a>
                    </div>
                </li>
                <li>
                    <a href="#!">目录</a>
                    <div class="subnav">
                        <a href="goods.html">商品管理</a>
                        <a href="category.html">分类管理</a>
                        <a href="breed.html">品种管理</a>
                    </div>
                </li>
                <li>
                    <a href="#!">客户</a>
                    <div class="subnav">
                        <a href="customers.html">客户管理</a>
                    </div>
                </li>
                <li><a href="#!">促销</a></li>
                <li><a href="#!">邮件列表</a></li>
                <li><a href="#!">CMS</a></li>
                <li><a href="#!">报表</a></li>
                <li>
                    <a href="#!">系统</a>
                    <div class="subnav">
                        <a href="user.html">用户管理</a>
                        <a href="role.html">角色管理</a>
                    </div>
                </li>
            </ul>
        </div>
    </div><!-- nav end -->


    <!-- fa-floor start -->
    <div class="create-order create-enquiry">
        <div class="wrap">
            <div class="title">
                <h3><i class="fa fa-chevron-right"></i>为hehuan报价</h3>
                <div class="extra">
                    <button type="submit" class="btn btn-red" id="submit">报价</button>
                </div>
            </div>
            
            <div class="main">
                <div class="chart-info">
                    <form action="" id="myform" class="chart tc">
                        <table>
                            <thead>
                                <tr>
                                    <th width="150">商品名称</th>
                                    <th width="150">片型</th>
                                    <th>规格等级</th>
                                    <th width="120">产地</th>
                                    <th width="120">单价（元/公斤）</th>
                                    <th width="120">操作</th>
                                </tr>
                            </thead>
                            <tfoot>
                                <tr>
                                    <td colspan="6">
                                        <a href="javascript:;" class="add">+ 添加一行</a>
                                    </td>
                                </tr>
                            </tfoot>
                            <tbody>
                                <tr>
                                    <td><div class="ipt-wrap pr"><input type="text" class="ipt ipt-name" name="name" autocomplete="off"></div><span class="error"></span></td>
                                    <td><div class="ipt-wrap pr"><input type="text" class="ipt" name="spec" autocomplete="off"></div><span class="error"></span></td>
                                    <td><div class="ipt-wrap pr"><input type="text" class="ipt" name="level" autocomplete="off"></div><span class="error"></span></td>
                                    <td><div class="ipt-wrap pr"><input type="text" class="ipt" name="originof" autocomplete="off"></div><span class="error"></span></td>
                                    <td><input type="text" class="ipt price" name="price" value="" autocomplete="off"><span class="error"></span></td>
                                    <td><a href="javascript:;" class="remove c-red">删除</a></td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="ipt-tr">
                            <span>报价有效期至：</span>
                            <input type="text" class="ipt" autocomplete="off">
                        </div>
                    </form>
                </div>
            </div>
        </div><!-- fa-floor end -->
    </div>


    <!-- footer start -->
    <div class="footer">
        <div class="wrap">            
            <div class="copyright">
                <p>药优优电商管理系统 版本 1.0  版权所有 &copy; 2016 药优优</p>
            </div>
        </div>
    </div><!-- footer end -->

    <!-- 输入框联想 start -->
    <div class="suggestions" id="suggestions" style="width:860px;">
        <div class="hd">
            <div class="group">
                <span class="w1">商品名称</span><span class="w2">片型</span><span class="w3">规格等级</span><span class="w4">产地</span><span class="w5">当前价格</span><span class="w6">上次成交价格</span>
            </div>
        </div>
        <div class="bd"></div>
    </div><!-- 输入框联想 end -->

    <script type="temp" id="jmodal">
        <tr>
            <td><div class="ipt-wrap"><input type="text" class="ipt ipt-name" name="name" autocomplete="off"></div><span class="error"></span></td>
            <td><div class="ipt-wrap"><input type="text" class="ipt" name="spec" autocomplete="off"></div><span class="error"></span></td>
            <td><div class="ipt-wrap"><input type="text" class="ipt" name="level" autocomplete="off"></div><span class="error"></span></td>
            <td><div class="ipt-wrap"><input type="text" class="ipt" name="originof" autocomplete="off"></div><span class="error"></span></td>
            <td><input type="text" class="ipt price" name="price" value="" autocomplete="off"><span class="error"></span></td>
            <td><a href="javascript:;" class="remove c-red">删除</a></td>
        </tr>
    </script>
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery.mousewheel.min.js"></script>
    <script src="js/laydate/laydate.js"></script>
    <script src="js/layer/layer.js"></script>
    <script src="js/validator/jquery.validator.min.js?local=zh-CN"></script>
    <script src="js/jquery.pagination.min.js"></script>
    <script src="js/common.js"></script>
    <script>
        var enquiryPage = {
            v: {},
            fn: {
                init: function() {
                    this.myformEvent();
                    this.formValidate();
                    this.pic2();
                    // this.pic();
                    // this.drag();
                },
                pic2: function() {
                    var imgList = ['http://192.168.1.51/static/uploads/c.jpg','http://static.sghaoyao.com/anon/2017/3/d7685ba4-320e-4026-a7e3-cf2dd8f2bc5f.jpg','http://192.168.1.51/static/uploads/a.jpg','http://192.168.1.51/static/uploads/b.jpg','http://192.168.1.51/static/uploads/c.jpg','http://192.168.1.51/static/uploads/d.jpg'],
                        templete = '<div class="pic2"> \n <div class="hd"><span class="min"></span><span class="max"></span></div> \n <div class="img"><img src="images/blank.gif"><i></i></div> \n <div class="thumb"></div></div>',
                        pages = [],
                        zoom = 100,
                        maxZoom = 1500,
                        minZoom = 50,
                        $pic, img, imgW, imgH, objW, objH;

                    var position = function(zoom, e) {
                        var w = imgW;
                        var h = imgH;
                        var wRatio = objW / w;
                        var hRatio = objH / h;
                        var Ratio = Math.min(wRatio, hRatio);
                        e = e || {};
                        e = {
                            x: e.clientX || 0,
                            y: e.clientY || 0,
                            x1: e.offsetX || 0,
                            y1: e.offsetY || 0
                        }

                        if (Ratio < 1) {
                            w = w * Ratio;
                            h = h * Ratio;
                        }
                        if (zoom) {
                            w = w * zoom;
                            h = h * zoom;
                        }

                        if (objW < w) {

                            var left = parseFloat(img.style.left),
                                top = parseFloat(img.style.top);

                            img.style.left = -left + 'px';
                            img.style.top = -top + 'px';

                            img.style.left = (objW - w)/2 + 'px';
                            img.style.top = (objH - h)/2 + 'px';

                        } else {
                            img.style.left = (objW - w)/2 + 'px';
                            img.style.top = (objH - h)/2 + 'px';
                        }
                        img.style.width = w + 'px';
                        img.style.height = h + 'px';
                        img.style.display = 'block';
                    }

                    if (imgList.length === 0) {
                        return this;
                    }

                    $('body').append(templete);
                    $pic = $('.pic2');
                    img = $pic.find('.img img')[0];
                    img.onload = function() {
                        imgW = this.width;
                        imgH = this.height;
                        // 图片显示在正中间
                        position(1);
                    }
                    objW = $pic.outerWidth();
                    objH = $pic.find('.img').outerHeight();
                    // 显示第一张图片
                    img.src = imgList[0];

                    $pic.on('click', function(e) {
                        e = {
                            x: e.clientX || 0,
                            y: e.clientY || 0,
                            // x1: e.offsetX || 0,
                            // y1: e.offsetY || 0,
                            left: img.style.left, 
                            top: img.style.top, 
                            zoom: zoom,
                        }
                        console.log(e)
                    })

                    // 生成分页
                    $.each(imgList, function(i, url) {
                        pages.push('<span><img src="', url, '" /></span>');
                    })
                    $pic.find('.thumb').html(pages.join('')).find('span:eq(0)').addClass('curr');


                    // 切换图片
                    $pic.on('click', '.thumb img', function() {
                        img.style.display = 'none';
                        img.src = this.src;
                        zoom = 100;
                        $(this).parent().addClass('curr').siblings().removeClass('curr');
                    })

                    // 滚轮缩放
                    $pic.on('mousewheel', '.img', function(e) {
                        zoom += e.deltaY * zoom/6;
                        // zoom += e.deltaY * 4;
                        if (zoom > maxZoom) {
                            zoom = maxZoom;
                        } else if (zoom < minZoom) {
                            zoom = minZoom;
                        } else {
                            position(zoom/100, e);
                            // position(2)
                        }
                        if (zoom > 100) {
                            $(this).addClass('move');
                        } else {
                            $(this).removeClass('move');
                        }
                        // 阻止浏览器滚动条滚动
                        e.preventDefault();
                    })

                    // 禁止拖动图片
                    $pic.on('dragstart', 'img', function(e) {
                        return false;
                    })

                    // img drag
                    $pic.on({
                        'mousedown touchstart': function(t) {
                            t.preventDefault();
                            var n = t.pageX,
                                e = t.pageY,
                                r = $(this).outerHeight(),
                                a = $(this).outerWidth(),
                                s = $(this).offset().top + r - e,
                                p = $(this).offset().left + a - n;

                            $(this).on('mousemove touchmove', function(t) {
                                var n = t.pageY + s - r,
                                    e = t.pageX + p - a;
                                $(this).offset({
                                    top: n,
                                    left: e
                                })
                            })
                        },
                        'mouseup': function() {
                            $(this).off("mousemove")
                        },
                        'mouseout': function() {
                            $(this).off("mousemove")
                        }
                    }, '.move img');

                },
                pic: function() {
                    var imgList = ['http://static.sghaoyao.com/anon/2017/3/d7685ba4-320e-4026-a7e3-cf2dd8f2bc5f.jpg','http://static.sghaoyao.com/anon/2017/3/d7685ba4-320e-4026-a7e3-cf2dd8f2bc5f.jpg','http://static.sghaoyao.com/anon/2017/3/d7685ba4-320e-4026-a7e3-cf2dd8f2bc5f.jpg'],
                        width = 530,
                        templete = '<div class="picture"> \n <div class="img"> \n <img width="' + width + '" src="images/blank.gif"> \n </div></div>',
                        pages = [],
                        $pic, img;  

                    if (imgList.length === 0) {
                        return this;
                    }
                    $('body').append(templete);
                    $pic = $('.picture');
                    img = $pic.find('img')[0];

                    // 禁止拖动图片
                    $pic.on('dragstart', 'img', function(e) {
                        return false;
                    })
                    // 生成分页
                    $.each(imgList, function(i) {
                        pages.push('<span class="p">', (i + 1),'</span>');
                    })
                    pages.push('<span class="maxmize" title="展开"></span>');
                    pages.push('<span class="minimize" title="收起"></span>');
                    pages.push('<span class="small" title="缩小"></span>');
                    pages.push('<span class="big" title="放大"></span>');
                    pages.push('</div>');
                    pages.unshift('<div class="toolbar">');
                    $pic.append(pages.join('')).find('span:eq(0)').addClass('curr');
                    $pic.show();

                    // 显示第一张图片
                    img.src = imgList[0];
                    img.width = width;

                    // 放大
                    $pic.on('click', '.big', function() {
                        width += 30;
                        if (width < 1030) {
                            img.width = width;
                        } else {
                            width = 1030;
                        }
                    })
                    // 缩小
                    $pic.on('click', '.small', function() {
                        width -= 30;
                        if (width >= 530) {
                            img.width = width;
                        } else {
                            width = 530;
                        }
                    })
                    // 最小化
                    $pic.on('click', '.minimize', function() {
                        $pic.addClass('pic-mini');
                    })
                    // 最小化
                    $pic.on('click', '.maxmize', function() {
                        $pic.removeClass('pic-mini');
                    })
                    // 切换图片
                    $pic.on('click', '.p', function() {
                        width = 530;
                        img.src = imgList[$(this).index()];
                        img.width = width;
                        $(this).addClass('curr').siblings().removeClass('curr');
                    })


                    // $('.optiscroll').optiscroll({
                    //     maxTrackSize: 175
                    // })//.append('<div class="noselect"></div>')
                },
                drag: function() {
                    var o = this,
                        $pic = $('.picture');

                    // pic drag to set width
                    $pic.on('mousedown', function(t) {
                        t.preventDefault();
                        dict.resizeStart = true;
                        dict.offset = [e.clientX, e.clientY];
                        dict.area = [
                            layero.outerWidth()
                            ,layero.outerHeight()
                        ];
                        ready.moveElem.css('cursor', 'se-resize').show();
                    })

                    // img drag
                    $pic.on({
                        'mousedown touchstart': function(t) {
                            t.preventDefault();
                            var n = t.pageX,
                                e = t.pageY,
                                i = $(this).css("z-index"),
                                r = $(this).outerHeight(),
                                a = $(this).outerWidth(),
                                s = $(this).offset().top + r - e,
                                p = $(this).offset().left + a - n,
                                objW = $pic.width(), 
                                objH = $pic.height(),
                                imgW = $(this).width(), 
                                imgH = $(this).height();

                            $(this).on("mousemove touchmove", function(t) {
                                var n = t.pageY + s - r,
                                    e = t.pageX + p - a;
                                $(this).offset({
                                    top: n,
                                    left: e
                                })


                                if (objH < imgH) {
                                    parseInt($(this).css("top")) > 0 && ($(this).css("top", 0));
                                    var c = -(imgH - objH);
                                    parseInt($(this).css("top")) < c && ($(this).css("top", c))
                                } else {
                                    parseInt($(this).css("top")) < 0 && ($(this).css("top", 0));
                                    var c = objH - imgH;
                                    parseInt($(this).css("top")) > c && ($(this).css("top", c))
                                }
                                if (objW < imgW) {
                                    parseInt($(this).css("left")) > 0 && ($(this).css("left", 0));
                                    var m = -(imgW - objW);
                                    parseInt($(this).css("left")) < m && ($(this).css("left", m));
                                } else {
                                    parseInt($(this).css("left")) < 0 && ($(this).css("left", 0));
                                    var m = objW - imgW;
                                    parseInt($(this).css("left")) > m && ($(this).css("left", m));
                                }
                            })
                        },
                        'mouseup': function() {
                            $(this).off("mousemove")
                        },
                        'mouseout': function() {
                            $(this).off("mousemove")
                        }
                    }, 'img');
                },
                myformEvent: function() {
                    var $body        = $('body');
                    var $suggestions = $('#suggestions');
                    var $myform      = $('#myform');
                    var $tbody       = $myform.find('tbody');
                    var $ipt         = $tbody.find('.ipt:first');
                    var modal        = $('#jmodal').html();
                    var self         = this;

                    // 单价
                    $myform.on({
                        'keyup': function() {
                            var val = this.value;
                            if (!/^\d+\.?\d*$/.test(val)) {
                                val = Math.abs(parseFloat(val));
                                this.value = isNaN(val) ? '' : val;
                            }
                        }
                    }, '.price');

                    // 商品名联想
                    $myform.on({
                        'click': function(event) {
                            event.stopPropagation();
                        },
                        'focus': function() {
                            $(this).after($suggestions);
                            $suggestions.find('.group').length > 1 && $suggestions.show();
                        },
                        'input': function() {
                            self.getKeywords(this.value);                           
                        }
                    }, '.ipt-name');

                    // 关闭联想层
                    $body.on('click', function() {
                        $suggestions.hide();
                    })
                    $body.on('click', '.suggestions', function(event) {
                        event.stopPropagation();
                    })

                    // 关键字自动填充
                    $body.on('click', '.suggestions .bd .group', function() {
                        var data = $(this).data('val').split('-');
                        $suggestions.prev().val(data[0])
                        .closest('td').next().find('.ipt').val(data[1]).trigger('focus').end()
                        .closest('td').next().find('.ipt').val(data[2]).trigger('focus').end()
                        .closest('td').next().find('.ipt').val(data[3]).trigger('focus');
                        $suggestions.hide();
                    })

                    // 新增一行
                    $myform.on('click', '.add', function() {
                        $tbody.append(modal);
                    })

                    // 删除一行
                    $myform.on('click', '.remove', function() {
                        var $tr = $(this).closest('tr');

                        // 弹层确认删除
                        // layer.confirm('确认删除行？', {icon: 3, title:'提示'}, function(index){
                            $tr.remove();
                            // layer.close(index);
                        // });       
                    })
                },
                // ajax 查询关键词
                getKeywords: function(keywords) {
                    var self = this;
                    var keywords = $.trim(keywords);
                    if (keywords === '') {
                        $('#suggestions').hide();
                    } else {
                        // ajax 查询关键词
                        self.timer && clearTimeout(self.timer);
                        self.timer = setTimeout(function() {
                            self.ajaxSearch();
                        }, 500);                
                    }               
                },
                ajaxSearch: function() {
                    var self = this;
                    $.ajax({
                        url: 'json/keywords.php',
                        dataType: 'json',
                        success: function(data) {
                            // 显示查询结果 
                            if (data.status === 'success') {
                                if (data.list.length === 0) {
                                    $('#suggestions').show().find('.bd').empty().html('暂无此商品:)');
                                } else {
                                    self.toHtml(data.list, 0 ,7);
                                }
                            } else {
                                $('#suggestions').hide();
                            }
                        }
                    })
                },
                // 显示查询结果
                toHtml: function(item, page_index, pageSize) {
                    var modal = [],
                        maxPage = Math.min((page_index + 1) * pageSize, item.length),
                        hasPage = pageSize < item.length;

                    for (var i = page_index * pageSize; i < maxPage; i++) {
                        var val = item[i].name + '-' + item[i].spec + '-' + item[i].level + '-' + item[i].originOf;
                        modal.push('<div class="group" data-val="', val, '">');
                        modal.push(     '<span class="w1">', item[i].name, '</span>');
                        modal.push(     '<span class="w2">', item[i].spec, '</span>');
                        modal.push(     '<span class="w3">', item[i].level, '</span>');
                        modal.push(     '<span class="w4">', item[i].originOf, '</span>');
                        modal.push(     '<span class="w4">&yen;22</span>');
                        modal.push('</div>');
                    }
                    hasPage && modal.push('<div class="jq-page"></div>');
                    $('#suggestions').show().find('.bd').empty().html(modal.join(''));
                    hasPage && this.showPage(item, page_index, pageSize);
                },
                showPage: function(item, page_index, pageSize) {
                    var self = this;
                    $('.jq-page').pagination(item.length, {
                        items_per_page: pageSize, //pageSize 每页显示数量
                        current_page: page_index, //默认pageIndex,0(默认),false(不加载)
                        num_edge_entries: 2, //1(任何情况下都显示第一页和最后一页),0(不显示)
                        callback: function(page_index) {
                            self.toHtml(item, page_index, pageSize);
                        }
                    })
                    $('.jq-page').prepend('<div class="p-size">总共' + item.length + '条记录</div>')
                },
                // 裸价
                pirceInput: function() {
                    $('#myform').on('keyup', '.ipt-price', function(e) {
                        var val = this.value;
                        if (!/^\d+\.?\d*$/.test(val)) {
                            val = Math.abs(parseFloat(val));
                            this.value = isNaN(val) ? '' : val;
                        }
                        if (e.keyCode === 13) {
                            $(this).closest('tr').next().find('.ipt-price').focus();
                        }
                    });
                },
                formValidate: function () {
                    $('#myform').validator({
                        fields: {
                            name: 'required'
                        }
                    })

                    $('#submit').on('click', function() {
                        if ($('#myform').isValid()) {
                        } else {
                        }
                    })
                }
            }
        }
        $(function() {
            enquiryPage.fn.init();
        })
    </script>
</body>
</html>

<script>
// 以下js为本地导航模板代码，上线时请删掉
$(function() {
    $.ajax({
        url: 'nav.html',
        success: function(menu) {
            $('.nav').html(menu);

            var $side = $('.nav'),
                URL = document.URL.split('#')[0].split('?')[0].toLowerCase();

            $side.find('a').each(function() {
                if (URL === this.href.toLowerCase()) {
                    $(this).addClass("on").parent().prev().addClass('curr');
                    return false; // break
                }
            }) 
        }
    })
})
</script>