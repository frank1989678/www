!function(o,t){var n=.5,e=40,i=10,r=5,a={loadPicture:"",hideButton:!1,uploadUrl:"",uploadData:{},cropUrl:"",cropData:{},customUploadButtonId:"",loaderHtml:'<span class="loader">图片上传中...</span>',scaleToFill:!0},s=function(){var o=t.createElement("input");return o.type="file","multiple"in o&&"undefined"!=typeof File&&"undefined"!=typeof FormData&&"undefined"!=typeof(new XMLHttpRequest).upload}();o.Croppic=function(o,t){this.id=o,this.options=$.extend({},a,t||{}),this.obj=$("#"+o),this.objW=this.obj.width(),this.objH=this.obj.height(),this.init()},Croppic.prototype={init:function(){var o=this;o.wait=!1,o.actualRotation=0,o.imgInitW=0,o.imgInitH=0,o.imgW=0,o.imgH=0,o.options.customUploadButtonId?o.imgUploadControl=$("#"+o.options.customUploadButtonId):(o.obj.append('<div class="cropControls"><i class="cropControlUpload"></i></div>'),o.imgUploadControl=o.obj.find(".cropControlUpload")),o.options.loadPicture?o.loadExistingImage():o.bindImgUploadControl()},loadExistingImage:function(){var o=this,t=new Image;o.onBeforeImgUpload('<span class="loader">图片加载中...</span>'),t.onload=function(){o.imgUrl=o.options.loadPicture,o.imgInitW=o.imgW=this.width,o.imgInitH=o.imgH=this.height,o.initCropper(),o.hideLoader(),o.onAfterImgUpload({url:o.imgUrl})},t.onerror=function(){o.hideLoader(),o.bindImgUploadControl()},t.src=o.options.loadPicture},bindImgUploadControl:function(){var o=this;s?o.createForm():o.CreateFallbackIframe(),o.imgUploadControl.on("click",function(){o.wait||(s?o.form.find('input[type="file"]').trigger("click"):o.iframeform.find('input[type="file"]').trigger("click"))})},createForm:function(){var o=this,n='<form class="'+o.id+'_imgUploadForm" style="visibility:hidden;"> \n <input type="file" name="img"> \n </form>';o.obj.append(n),o.form=o.obj.find("."+o.id+"_imgUploadForm"),o.form.on("change",'input[type="file"]',function(){o.onBeforeImgUpload();try{formData=new FormData(o.form[0])}catch(n){formData=new FormData,formData.append("img",o.form.find("input[type=file]")[0].files[0])}for(var e in o.options.uploadData)o.options.uploadData.hasOwnProperty(e)&&formData.append(e,o.options.uploadData[e]);$.ajax({url:o.options.uploadUrl,data:formData,context:t.body,cache:!1,contentType:!1,processData:!1,type:"POST"}).always(function(t){o.afterUpload(t),o.form.html('<input type="file" name="img">')})})},CreateFallbackIframe:function(){var o=this,n=this.id+"_upload_iframe",e=t.createElement("iframe"),i='<!DOCTYPE html><html><head><title>Uploading File</title></head><body><form name="upload_form" action="'+o.options.uploadUrl+'" method="post" enctype="multipart/form-data" encoding="multipart/form-data"> \n <input type="file" name="img"> \n </form></body></html>';$("#"+n).remove(),e.id=n,e.width=0,e.height=0,e.border=0,e.src="javascript:false;",e.style.display="none",t.body.appendChild(e),e.contentWindow.document.open("text/htmlreplace"),e.contentWindow.document.write(i),e.contentWindow.document.close(),o.iframeobj=$("#"+n),o.iframeform=o.iframeobj.contents().find("html").find("form"),o.iframeform.find("input").on("change",function(){o.onBeforeImgUpload(),o.iframeform[0].submit()}),e.onload=function(){var t=o.getIframeContentJSON(e);e.onload=null,o.afterUpload(t),o.CreateFallbackIframe()}},getIframeContentJSON:function(o){var t,n,e;try{t=o.contentDocument?o.contentDocument:o.contentWindow.document,e=t.body.innerHTML,"<pre>"==e.slice(0,5).toLowerCase()&&"</pre>"==e.slice(-6).toLowerCase()&&(e=t.body.firstChild.firstChild.nodeValue),n=jQuery.parseJSON(e)}catch(i){n={success:!1}}return n},afterUpload:function(o){var t=this,n="object"==typeof o?o:jQuery.parseJSON(o);if("success"==n.status){var e=new Image;e.onload=function(){t.initCropper(),t.hideLoader(),t.onAfterImgUpload(n)},e.onerror=function(){t.hideLoader(),t.onError("图片上传失败")},e.src=n.url,t.imgUrl=n.url,t.imgInitW=t.imgW=n.width||e.width,t.imgInitH=t.imgH=n.height||e.height}"error"==n.status&&(t.hideLoader(),t.onError(n.message))},initCropper:function(){var o=this;return o.options.cropUrl?(o.obj.html('<div class="cropImgWrapper" style="overflow:hidden; z-index:1; position:absolute; width:'+o.objW+"px; height:"+o.objH+'px;"><img src="'+o.imgUrl+'" /></div>'),o.img=o.obj.find("img"),o.createCropControls(),o.createEyecandy(),o.initDrag(),void o.initialScaleImg()):this},createCropControls:function(){var o=this,t=[];t.push('<div class="cropControls cropControlsCrop">'),t.push('<i class="cropControlZoomMuchIn"></i>'),t.push('<i class="cropControlZoomIn"></i>'),t.push('<i class="cropControlZoomOut"></i>'),t.push('<i class="cropControlZoomMuchOut"></i>'),t.push('<i class="cropControlRotateLeft"></i>'),t.push('<i class="cropControlRotateRight"></i>'),t.push('<i class="cropControlCrop"></i>'),t.push('<i class="cropControlReset"></i>'),t.push("</div>"),o.obj.append(t.join("")),o.cropControlsCrop=o.obj.find(".cropControlsCrop"),o.cropControlsCrop.on("click",".cropControlZoomMuchIn",function(){o.zoom(10*i)}),o.cropControlsCrop.on("click",".cropControlZoomIn",function(){o.zoom(i)}),o.cropControlsCrop.on("click",".cropControlZoomOut",function(){o.zoom(-i)}),o.cropControlsCrop.on("click",".cropControlZoomMuchOut",function(){o.zoom(10*-i)}),o.cropControlsCrop.on("click",".cropControlRotateLeft",function(){o.rotate(-r)}),o.cropControlsCrop.on("click",".cropControlRotateRight",function(){o.rotate(r)}),o.cropControlsCrop.on("click",".cropControlCrop",function(){o.crop()}),o.cropControlsCrop.on("click",".cropControlReset",function(){o.reset()})},createEyecandy:function(){var o=this;o.imgEyecandy=o.img.clone(),o.imgEyecandy.css({"z-index":"0",opacity:n}).appendTo(o.obj)},initialScaleImg:function(){var o=this;o.zoom(-o.imgInitW),o.zoom(e),o.img.css({left:-(o.imgW-o.objW)/2,top:-(o.imgH-o.objH)/2,position:"relative"}),o.imgEyecandy.css({left:-(o.imgW-o.objW)/2,top:-(o.imgH-o.objH)/2,position:"relative"})},initDrag:function(){var o=this;o.img.on("mousedown touchstart",function(t){t.preventDefault();var n=t.pageX,e=t.pageY,i=o.img.css("z-index"),r=o.img.outerHeight(),a=o.img.outerWidth(),s=o.img.offset().top+r-e,p=o.img.offset().left+a-n;o.img.css("z-index",1e3).on("mousemove touchmove",function(t){var n=t.pageY+s-r,e=t.pageX+p-a;if(o.img.offset({top:n,left:e}).on("mouseup",function(){$(this).css("z-index",i)}),o.imgEyecandy.offset({top:n,left:e}),o.objH<o.imgH){parseInt(o.img.css("top"))>0&&(o.img.css("top",0),o.imgEyecandy.css("top",0));var c=-(o.imgH-o.objH);parseInt(o.img.css("top"))<c&&(o.img.css("top",c),o.imgEyecandy.css("top",c))}else{parseInt(o.img.css("top"))<0&&(o.img.css("top",0),o.imgEyecandy.css("top",0));var c=o.objH-o.imgH;parseInt(o.img.css("top"))>c&&(o.img.css("top",c),o.imgEyecandy.css("top",c))}if(o.objW<o.imgW){parseInt(o.img.css("left"))>0&&(o.img.css("left",0),o.imgEyecandy.css("left",0));var m=-(o.imgW-o.objW);parseInt(o.img.css("left"))<m&&(o.img.css("left",m),o.imgEyecandy.css("left",m))}else{parseInt(o.img.css("left"))<0&&(o.img.css("left",0),o.imgEyecandy.css("left",0));var m=o.objW-o.imgW;parseInt(o.img.css("left"))>m&&(o.img.css("left",m),o.imgEyecandy.css("left",m))}})}).on("mouseup",function(){o.img.off("mousemove")}).on("mouseout",function(){o.img.off("mousemove")})},rotate:function(o){var t=this;t.actualRotation+=o,t.img.css({"-webkit-transform":"rotate("+t.actualRotation+"deg)","-moz-transform":"rotate("+t.actualRotation+"deg)",transform:"rotate("+t.actualRotation+"deg)"}),t.imgEyecandy.css({"-webkit-transform":"rotate("+t.actualRotation+"deg)","-moz-transform":"rotate("+t.actualRotation+"deg)",transform:"rotate("+t.actualRotation+"deg)"})},zoom:function(o){var t=this,n=t.imgW/t.imgH,e=t.imgW+o,i=e/n,r=!0;(e<t.objW||i<t.objH)&&(e-t.objW<i-t.objH?(e=t.objW,i=e/n):(i=t.objH,e=n*i),r=!1),!t.options.scaleToFill&&(e>t.imgInitW||i>t.imgInitH)&&(e-t.imgInitW<i-t.imgInitH?(e=t.imgInitW,i=e/n):(i=t.imgInitH,e=n*i),r=!1),t.imgW=e,t.img.width(e),t.imgH=i,t.img.height(i);var a=parseInt(t.img.css("top"))-o/2,s=parseInt(t.img.css("left"))-o/2;a>0&&(a=0),s>0&&(s=0);var p=-(i-t.objH);p>a&&(a=p);var c=-(e-t.objW);c>s&&(s=c),r&&t.img.css({top:a,left:s}),t.imgEyecandy.width(e),t.imgEyecandy.height(i),r&&t.imgEyecandy.css({top:a,left:s})},crop:function(){var o=this;o.onBeforeImgCrop(),o.cropControlsCrop.hide();var n,e={imgUrl:o.imgUrl,imgInitW:o.imgInitW,imgInitH:o.imgInitH,imgW:o.imgW,imgH:o.imgH,imgY1:Math.abs(parseInt(o.img.css("top"))),imgX1:Math.abs(parseInt(o.img.css("left"))),cropH:o.objH,cropW:o.objW,rotation:o.actualRotation};if("undefined"==typeof FormData){var i=new XMLHttpRequest,r="",a=[];for(var s in e)a.push(encodeURIComponent(s)+"="+encodeURIComponent(e[s]));for(var s in o.options.cropData)a.push(encodeURIComponent(s)+"="+encodeURIComponent(o.options.cropData[s]));r=a.join("&").replace(/%20/g,"+");var p=function(){o.onError("XHR Request failed")};i.addEventListener?i.addEventListener("error",p,!0):i.attachEvent&&i.attachEvent("onerror",p),i.onreadystatechange=function(){4==i.readyState&&200==i.status&&o.afterCrop(i.responseText)},i.open("POST",o.options.cropUrl),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.setRequestHeader("Content-Length",r.length),i.send(r)}else{n=new FormData;for(var s in e)e.hasOwnProperty(s)&&n.append(s,e[s]);for(var s in o.options.cropData)o.options.cropData.hasOwnProperty(s)&&n.append(s,o.options.cropData[s]);$.ajax({url:o.options.cropUrl,data:n,context:t.body,cache:!1,contentType:!1,processData:!1,type:"POST"}).always(function(t){o.afterCrop(t)})}},afterCrop:function(o){var t=this;response="object"==typeof o?o:jQuery.parseJSON(o),t.hideLoader(),t.imgEyecandy.hide(),t.onAfterImgCrop(),"success"==response.status&&t.destroy(),"error"==response.status&&(t.cropControlsCrop.show(),t.onError(response.message))},showLoader:function(o){var t=this;t.options.cropUrl?(t.obj.append(o||t.options.loaderHtml),t.loader=t.obj.find(".loader")):t.options.customUploadButtonId&&(t.imgUploadControl.html(o||t.options.loaderHtml),t.loader=t.imgUploadControl.find(".loader")),t.wait=!0,t.options.hideButton&&t.imgUploadControl.hide()},hideLoader:function(){var o=this;o.wait=!1,o.loader&&o.loader.remove(),o.imgUploadControl.show()},reset:function(){var o=this;o.destroy(),o.init(),o.onReset()},destroy:function(){var o=this;o.options.loadPicture="",o.imgUploadControl&&o.imgUploadControl.off("click"),o.loader&&o.loader.remove(),o.img&&o.img.off().remove(),o.imgEyecandy&&o.imgEyecandy.remove(),o.cropControlsCrop&&o.cropControlsCrop.off().remove(),o.iframeobj&&o.iframeobj.off().remove(),o.form&&o.form.off().remove(),o.obj.empty()},onBeforeImgUpload:function(o){var t=this;"function"==typeof t.options.onBeforeImgUpload&&t.options.onBeforeImgUpload.call(t),t.showLoader(o)},onAfterImgUpload:function(o){var t=this;"function"==typeof t.options.onAfterImgUpload&&t.options.onAfterImgUpload.call(t,o)},onBeforeImgCrop:function(){var o=this;"function"==typeof o.options.onBeforeImgCrop&&o.options.onBeforeImgCrop.call(o)},onAfterImgCrop:function(){var o=this;"function"==typeof o.options.onAfterImgCrop&&o.options.onAfterImgCrop.call(o,response)},onReset:function(){var o=this;"function"==typeof o.options.onReset&&o.options.onReset.call(o)},onError:function(o){var t=this;"function"==typeof t.options.onError&&t.options.onError.call(t,o)}}}(window,document);