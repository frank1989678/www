<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
  	
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>供应商详情-boss</title>
    <meta name="renderer" content="webkit" />
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
  	<link rel="stylesheet" href="assets/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/style.css" />
</head>
<body>

<div class="wrapper">
	<div class="content">
		<div class="breadcrumb">
			<ul>
                <li>供应商管理</li>
                <li>供应商详情</li>
    		</ul>
		</div>

		<div class="box fa-form">
			<div class="hd">基本信息</div>
            <form id="myform">
				<div class="item">
					<div class="txt"><i>*</i>姓名：</div>
					<div class="cnt">
						<input type="text" name="username" class="ipt" placeholder="请输入姓名" autocomplete="off">
                        <a href="supplier_edit2.html" class="c-blue ml">已入住</a>
					</div>
				</div>
				<div class="item">
					<div class="txt"><i>*</i>手机号：</div>
					<div class="cnt">
						<input type="text" name="mobile" class="ipt" placeholder="请输入手机号" autocomplete="off">
					</div>
				</div>
                <div class="item">
                    <div class="txt"><i>*</i>经营品种：</div>
                    <div class="cnt">
                        <div class="choose" id="chooseBreeds"></div>
                        <input type="text" name="breeds" id="breeds" class="ipt" placeholder="请输入入驻品种" autocomplete="off">
                        <input type="hidden" value="" name="breedsId" id="breedsId">
                    </div>
                </div>
                <div class="item">
                    <div class="txt">公司：</div>
                    <div class="cnt">
                        <input type="text" name="company" class="ipt" placeholder="请输入手机号" autocomplete="off">
                    </div>
                </div>
				<div class="item">
					<div class="txt">地区：</div>
					<div class="cnt">
                        <select class="slt" name="province" id="province">
                            <option value="">-省-</option>
                        </select>
                        <select class="slt" name="city" id="city">
                            <option value="">-市-</option>
                        </select>
					</div>
				</div>
                <div class="item">
                    <div class="txt">邮箱：</div>
                    <div class="cnt">
                        <input type="text" name="email" class="ipt" placeholder="请输入邮箱" autocomplete="off">
                    </div>
                </div>
				<div class="item">
					<div class="txt">信息来源：</div>
					<div class="val">系统录入</div>
				</div>
				<div class="item">
					<div class="txt">备注：</div>
					<div class="cnt">
                        <textarea name="note" class="ipt ipt-mul" cols="30" rows="10"></textarea>
					</div>
				</div>

				<div class="ft">
					<button type="submit" class="ubtn ubtn-blue" id="jsubmit">保存</button>
				</div>
            </form>
		</div>

        <div class="box fa-form">
            <div class="hd">入驻商品</div>
            <div class="list">
                <ul>
                    <li>
                        <div class="pimg">
                            <img class="" src="http://static.yaobest.com/commodity/2016/11/71a7db7b-f381-4874-9f7a-95e13f0bd24bCrop.jpg" width="100" alt="">
                        </div>
                        <div class="info">
                            <strong>三棱</strong>
                            <span>去毛统个、长2cm-6cm、直径2cm-4cm</span>
                        </div>
                        <div class="edit">
                            <a href="javascript:;" class="ubtn ubtn-blue jprice" data-id="1">调价</a>
                        </div>
                        <div class="price">
                            <i>&yen;</i> 10.5元/公斤
                        </div>
                    </li>
                    <li>
                        <div class="pimg">
                            <img class="" src="http://static.yaobest.com/commodity/2016/11/d92ad1c9-4671-4b58-93e5-4f98ecf18a8eCrop.jpg" width="100" alt="">
                        </div>
                        <div class="info">
                            <strong>半夏</strong>
                            <span>旱半夏，统个，甘肃，过4号筛，直径0.4cm~1.4cm</span>
                        </div>
                        <div class="edit">
                            <a href="javascript:;" class="ubtn ubtn-blue jprice" data-id="1">调价</a>
                        </div>
                        <div class="price">
                            <i>&yen;</i> 105元/公斤
                        </div>
                    </li>
                    <li>
                        <div class="pimg">
                            <img class="" src="http://static.yaobest.com/commodity/2016/11/2c6a4c81-7ec5-4301-8c3c-4ad171c6dab7Crop.jpg" width="100" alt="">
                        </div>
                        <div class="info">
                            <strong>白芍</strong>
                            <span>亳白芍，选片，亳州，14-16号筛，趁鲜加工，5年生，无硫</span>
                        </div>
                        <div class="edit">
                            <a href="javascript:;" class="ubtn ubtn-blue jprice" data-id="1">调价</a>
                        </div>
                        <div class="price">
                            <i>&yen;</i> 37元/公斤
                        </div>
                    </li>

                </ul>
            </div>
        </div>


        <div class="box fa-form">
            <div class="hd">跟踪记录</div>
            <ol class="trace" id="trace">
                <li>
                    <span>李笑</span>
                    <span>2017年3月1日 11：30</span>
                    <span>到访该供应商加工厂地，达成初步合作意向。</span>
                </li>
            </ol>
            <form action="" id="traceForm">
                <div class="item">
                    <div class="txt">跟踪记录：</div>
                    <div class="cnt">
                        <textarea name="consigneeNote" class="ipt ipt-mul" placeholder="跟踪记录"></textarea>
                    </div>
                </div>
                <div class="ft">
                    <button type="button" class="ubtn ubtn-blue submit">提交</button>
                </div>
            </form>
        </div>

        <div class="box fa-form">
            <div class="hd">供应商照片</div>
            <div class="pics thumb">
                <div class="up-img" id="jpic"></div>
            </div>
        </div>
        
        <div class="box fa-form">
            <div class="hd">供应商入驻</div>
            <form id="myform3">
                <div class="item">
                    <div class="txt">登录帐号：</div>
                    <div class="val">18801285391</div>
                </div>
                <div class="item">
                    <div class="txt">密码：</div>
                    <div class="cnt">
                        <input type="text" name="pwd" class="ipt ipt-short" autocomplete="off">
                        <a href="javascript:;" class="c-blue ml">生成随机密码</a>
                    </div>
                </div>
                <div class="ft">
                    <button type="button" class="ubtn ubtn-blue submit">同意入驻</button>
                    <span class="tips">注：点击同意入驻后帐号和密码将以短信形式发送到供应商手机</span>
                </div>
            </form>
        </div>
	</div>
</div>

<!-- 快速调价弹出框 -->
<form id="priceForm" class="hide">
    <div class="fa-form fa-form-layer">
        <div class="item" style="max-height:300px;overflow:hidden;overflow-y:auto;">
        </div>
        <div class="button">
            <button type="submit" class="ubtn ubtn-blue">保存</button>
            <button type="button" class="ubtn ubtn-gray">取消</button>
        </div>
    </div>
</form>

<div id="imgCropWrap" class="hide"></div>

<script src="assets/js/jquery191.js"></script>
<script src="assets/js/common.js"></script>
<script src="assets/js/jquery.autocomplete.js"></script>
<script src="assets/plugins/layer/layer.js"></script>
<script src="assets/plugins/validator/jquery.validator.min.js"></script>
<script src="assets/js/croppic.min.js"></script>
<script src="assets/js/area.js"></script>
<script>
	var _global = {
        v: {
            flag: false
        },
		fn: {
			init: function() {
                this.changePrice();
                this.checkForm();
                this.searchBreeds();
                this.submitEvent();
                this.goodsImg();
			},
            changePrice: function() {
                var self = this;
                // 调价
                $('.list').on('click', '.jprice', function() {
                    if (_global.v.flag) {
                        return false;
                    }
                    _global.v.flag = true;
                    self.showinfo($(this).data('id'));
                    return false; // 阻止链接跳转
                })

                
                // 关闭弹层
                $('#priceForm').on('click', '.ubtn-gray', function () {
                    layer.closeAll();
                })
                .validator({
                    fields: {
                        price: '价格: required; range(1~9999)'
                    },
                    valid: function(form) {
                        alert('form passed');
                        // layer.closeAll(); // 关闭弹层
                        // location.reload(true);// 强制删除页面
                    }
                });
            },
            showinfo: function(id) {
                var showBox = function(data) {
                    var html = [];
                    switch (typeof data.price) {
                        case 'string':
                            html.push('<div class="txt"><i>*</i>价格：</div> \n <div class="cnt"> \n <div class="ipt-wrap"> \n <input type="text" name="price" class="ipt" id="jprice" value=' + data.price + ' placeholder="价格" autocomplete="off"> \n <span class="unit">元</span> \n </div> \n <label class="ml"><input type="checkbox" class="cbx" id="jsales">量大价优</label> \n </div>');
                            break;
                        case 'object':
                            html.push('<div class="txt"><i>*</i>公斤/价格：</div>');
                            $.each(data.price, function(i, item) {
                                var idx = i + 1;
                                html.push('<div class="cnt"> \n <div class="ipt-wrap"><input type="text" name="minKg' , idx , '" class="ipt ipt-short" value="' , item[0] , '" data-rule="required; range(1~99999)" placeholder="1-99999" autocomplete="off"></div> \n <em>-</em> \n <div class="ipt-wrap"><input type="text" name="maxKg' , idx , '" class="ipt ipt-short" value="' , item[1] , '" data-rule="required; range(1~99999)" placeholder="1-99999" autocomplete="off"></div> \n <em>公斤</em> \n <div class="ipt-wrap ml"> \n <input type="text" name="price' , idx , '" class="ipt ipt-short" value="' , item[2] , '" placeholder="1-9999" data-rule="required; range(1~9999)" autocomplete="off"> \n <span class="unit">元</span> \n </div> \n </div>');
                            });
                            break;
                    }

                    $('#priceForm').find('.item').html(html.join(''));

                    layer.closeAll();
                    layer.open({
                        skin: 'layer-form',
                        area: ['600px'],
                        type: 1,
                        moveType: 1,
                        content: $('#priceForm'),
                        title: '快速调价'
                    });
                }

                // 加载数据
                var k = $.ajax({
                    url: 'json/getPrice.php',
                    data: {id: id},
                    dataType: 'json',
                    success: function(data) {
                        showBox(data);
                    },
                    complete: function() {
                        _global.v.flag = false;
                    }
                })

                // loading
                layer.open({
                    area: ['200px'],
                    type: 1,
                    moveType: 1,
                    content: '<div class="layer-loading">加载中...</div>',
                    title: '快速调价',
                    cancel: function() {
                        k.abort();
                    }
                });
            },
            checkForm: function() {
            	// 表单验证
                $("#myform").validator({
                    fields: {
                    	username: '姓名: required',
                    	mobile: '手机号: required; mobile',
                    	breedsId: '经营品种: required',
                        email: '邮箱: email'
                    },
                    valid: function(form) {
                        // 验证成功
                        // 成功提示
                        $.notify({
                            type: 'success', 
                            title: '操作成功'
                        });
                    }
                });
            },
            // 查询品种
            searchBreeds: function() {
                var self = this;
                    vals = [],
                    timer = 0,
                    $breeds = $('#breeds'),
                    $breedsId = $('#breedsId'),
                    $chooseBreeds = $('#chooseBreeds'),
                    $breedsSuggestions = $('#breedsSuggestions');

                $breeds.autocomplete({
                    serviceUrl: 'json/breedlist.json',
                    paramName: 'name',
                    deferRequestBy: 100,
                    showNoSuggestionNotice: true,
                    noSuggestionNotice: '没有该品种',
                    transformResult: function (response) {
                        response = JSON.parse(response);
                        if (response.status == "y") {
                            return {
                                suggestions: $.map(response.data, function (dataItem) {
                                    return {value: dataItem.name, data: dataItem.id};
                                })
                            };
                        } else {
                            return {
                                suggestions: []
                            }
                        }
                    },
                    onSelect: function (suggestion) {
                        var id = suggestion.data,
                            val = suggestion.value;
                        if (self.inArray(id, vals)) {
                            $.notify({
                                type: 'error', 
                                title: '商品添加失败',
                                text: '此商品已在添加列表', 
                                delay: 3e3
                            });
                        } else {
                            vals.push(id);
                            $chooseBreeds.show().append('<span>' + val + '<i data-id="' + id + '"></i></span>');
                            $breedsId.val(vals.join(','));
                            $breeds.val(''); // 清空输入框
                            $breedsSuggestions.hide();
                        }
                    }
                });

                // 删除品种
                $chooseBreeds.on('click', 'i', function() {
                    var id = $(this).data('id');
                    $(this).parent().remove();
                    self.inArray(id, vals, true); // 删除当前id
                    $breedsId.val(vals.join(','));
                })
            },
            /**
             * [inArray 查询数组元素]
             * @param  {[string]} needle [查询值]
             * @param  {[Array]} array  [查询数组]
             * @param  {[bollen]} del    [选填，为true时删除该值]
             * @return {[bollen]}        [true or false]
             */
            inArray: function(needle, array, del) {
                if (typeof needle == 'string' || typeof needle == 'number') {
                    for (var i in array) {
                        if (array[i] == needle) {
                            del && array.splice(i, 1);
                            return true;
                        }
                    }
                }
                return false;
            },
            submitEvent: function() {
                var self = this,
                    $trace = $('#trace'),
                    $pa = $trace.parent();

                // 提交记录
                $pa.on('click', '.submit', function(){
                    var text = $('#traceForm').find('.ipt').val();
                    $.ajax({
                        url: '',
                        data: {msg: text},
                        success: function(data) {
                            data = {
                                date: '2016年10月20日 15:20',
                                operator: 'frank',
                                msg: text
                            }
                            $('#traceForm').find('.ipt').val('');
                            self.addNewRevord(data);
                        }
                    })
                })

                var $myform = $('#myform3');
                // 同意入驻
                $myform.find('.submit').on('click', function() {
                })
                // 随机密码
                $myform.find('.ml').on('click', function() {
                    $(this).prev().val((Math.random() * 10).toString().substr(2, 6));
                })
            },
            // 添加记录
            addNewRevord: function(data) {
                var html = [];
                $.each(data, function(i, item) {
                    html.push('<span>' + item + '</span>');
                })
                html.length > 1 && $('#trace').append('<li>' + html.join('') + '</li>');
            },
            // 商品图片
            goodsImg: function() {
                var self = this,
                    $el = $('#jpic');

                $('body').append('<div id="upload" style="position:fixed;bottom:0;left:0;width:0;height:0;visibility:hidden;"></div>');

                // 删除图片
                $('.thumb').on('click', '.del', function() {
                    var $self = $(this);
                    layer.confirm('确认删除图片？', function(index){
                        $el.css('display','inline-block');
                        $self.parent().remove();
                        layer.close(index);
                    });
                    return false;
                })

                // 上传图片
                $el.on('click', function() {
                    if ($(this).siblings().length > 9) {
                        $.notify({
                            type: 'error',
                            title: '最多只能上传10张图片'
                        });
                    } else {
                        $('#upload').find('.cropControlUpload').trigger('click');
                    }
                })

                var options = {
                    uploadUrl:'img_save_to_file.php',
                    onBeforeImgUpload: function() {
                        $el.html('<span class="loader">图片上传中...</span>');
                    },
                    onAfterImgUpload: function(response){
                        $el.empty('').before('<div class="up-img"><img src="' + response.url + '"/><i class="del"></i><input type="hidden" value="' + response.url + '" /></div>');
                        $el.siblings().length > 9 && $el.attr('style','display:none!important'); // 上传超过10张后隐藏
                    },
                    onError:function(msg){
                        $.notify({
                            type: 'error', 
                            title: '上传图片失败',   // 不允许的文件类型
                            text: msg,     //'支持 jpg、jepg、png、gif等格式图片文件', 
                            delay: 3e3
                        });
                    }
                }
                var cropModal = new Croppic('upload', options);
            }
		}
	}

	$(function() {
		_global.fn.init();
	})
</script>
</body>
</html>