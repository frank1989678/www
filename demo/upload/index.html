<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>用户中心 - 我的医药网</title>
    <link rel="stylesheet" href="css/style.css" />
    <script src="/static/js/jquery191.js"></script>
    <script src="js/jquery.ui.widget.js"></script>
    <script src="js/jquery.iframe-transport.js"></script>
    <script src="js/jquery.fileupload.js"></script>
    <script src="js/jquery.Jcrop.min.js"></script>
</head>

<body>
    <div class="setAvatar" id="addPhotoWrap">
        <form id="fileupload" method="post" enctype="multipart/form-data">
            <div class="tailor">
                <span class="wait" id="message"></span>
                <img id="previewImg" src="/static/images/blank.gif">
            </div>
            <div class="preview">
                <span>头像预览</span>
                <span class="portrait">
                    <span class="bd">
                        <img id="portrait" src="/static/images/blank.gif" />
                    </span>
                </span>
                <span class="button">选择图片<br />
                <input id="avatarUpload" type="file">
            </span>
                <input class="button" type="button" value="保存" id="saveAvatarBtn" />
            </div>
            <div class="tips">
                <p class="title">头像说明</p>
                <p>支持 jpg、jepg、png、gif等格式图片文件，文件大小不超过 <span>2000000 Bytes</span></p>
                <p>上传之后你可以随意拖拽及缩放方框来调整头像的截图区域</p>
            </div>
        </form>
    </div>
    <script type="text/javascript">
    // 上传头像
    var avatarHandlerServer = 'http://user.mypharma.com/user/logo',
        maxUploadFileSize = 2000000,
        acceptFileTypes = /\.(jpe?g|png|gif|bmp)$/i,
        previewImg = $('#previewImg'),
        message = $('#message'),
        portrait = $('#portrait'),
        jcrop_api,
        bound = [],
        coord = [], // 修剪图片坐标点及宽高
        imgPath = ""; // 图片的本地绝对路径

    // 文件上传
    $("#avatarUpload").fileupload({
        url: avatarHandlerServer,
        type: 'POST',
        dataType: 'json',
        dropZone: addPhotoWrap, //拖动文件即可上传的区域
        maxFileSize: maxUploadFileSize, // 限制上传的文件大小(bytes)
        acceptFileTypes: acceptFileTypes, // 限制的上传文件类型(正则匹配)
        singleFileUploads: true, //限制为单个文件上传，无效的
        limitMultiFileUploads: 1,
        sequentialUploads: true,
        limitConcurrentUploads: 1,
        multipart: true,
        //forceIframeTransport: true,
        drop: function(e, data) {
            // console.log('droped a file!');
        },
        add: function(e, data) {
            var error = false,
                that = $(this).data('fileupload'),
                files = data.files;
            $.each(files, function(i, file) {
                if (!acceptFileTypes.test(file.name)) {
                    showMsg("错误: 不允许的文件类型");
                    error = true;
                    return false; //退出循环
                } else if (file.size > maxUploadFileSize) {
                    showMsg("错误: 文件太大");
                    error = true;
                    return false; //退出循环
                }
            });
            if (error) {
                return false;
            };
            if ($('.jcrop-holder').length > 0) {
                jcrop_api.destroy();
            }
            showMsg("loading");
            data.formData = {
                action: 'upload'
            };
            data.submit();
        },
        done: function(e, data) {
            showMsg("hide");
            if (data.result.files && $.isArray(data.result.files)) {
                $.each(data.result.files, function(index, file) {
                    if (!file.error) {
                        var margin = Math.round((400 - file.height) / 2) + 'px 0 0 ' + Math.round((400 - file.width) / 2) + 'px';
                        previewImg.show().attr('src', file.url).width(file.width).height(file.height).css({
                            margin: margin,
                            display: "block"
                        });
                        $("#portrait").attr("src", file.url);
                        imgPath = file.path;
                        initJcrop(previewImg, margin);
                    } else if (file.error) {
                        showMsg('上传失败: ' + file.error);
                    }
                });
            }
        }
    });

    // 上传图片及时消息
    function showMsg(msg) {
        message.stop().removeClass("loading");
        if (msg === "loading") {
            message.html("").addClass("loading").show();
        } else if (msg === "hide") {
            message.hide();
        } else {
            message.html(msg).show(1).delay(4000).hide(1);
        }
    }

    // 初始化剪裁
    function initJcrop(target, margin) {
        $(target).Jcrop({
            minSize: [360, 360],
            setSelect: [0, 0, 200, 200],
            onChange: updatePreview,
            onSelect: updatePreview,
            aspectRatio: 1
        }, function() {
            $(".jcrop-holder").css({
                margin: margin
            });
            // Use the API to get the real image size
            bound = this.getBounds();
            // Store the API in the jcrop_api variable
            jcrop_api = this;
        });
    };

    // 实时预览头像
    function updatePreview(c) {
        if (parseInt(c.w) > 0) {
            var rx = 360 / c.w;
            var ry = 360 / c.h;
            $('#portrait').css({
                width: Math.round(rx * bound[0]) + 'px',
                height: Math.round(ry * bound[1]) + 'px',
                marginLeft: '-' + Math.round(rx * c.x) + 'px',
                marginTop: '-' + Math.round(ry * c.y) + 'px'
            });
            coord = [c.x, c.y, c.w, c.h];
        }
    };

    function checkCoords() {
        if (!imgPath) {
            showMsg('请先选择并上传图片');
            return false;
        } else if (coord.length === 0) {
            showMsg('请选择图片上合适的区域');
            return false;
        };
        return true;
    };

    // 提交到服务端进行剪裁和保存头像处理
    $(document).on("click", "#saveAvatarBtn", function() {
        if (checkCoords()) {
            $.ajax({
                type: "POST",
                url: avatarHandlerServer,
                data: {
                    "action": 'save',
                    "img": imgPath,
                    "x": coord[0],
                    "y": coord[1],
                    "w": coord[2],
                    "h": coord[3]
                },
                dataType: "json",
                success: function(d) {
                    jcrop_api.release();
                    if (d.status == 1) {
                        showMsg('保存成功');
                        document.domain = 'mypharma.com'; //强制同域
                        parent.refreshAvatar(d.data.url);
                    } else {
                        showMsg('保存失败: ' + d.data.error);
                    }
                }
            });
        }
        return false;
    });
    </script>
</body>

</html>
